/*! Perlenspiel 3.2.1 2014-12-16 */
var AQ=function(a){"use strict";function b(a){var b;return b=typeof a,"number"===b?isNaN(a)&&(b="NaN"):"object"===b&&(a?a instanceof Array&&(b="array"):b="null"),b}function c(a){return a.stopPropagation?a.stopPropagation():a.cancelBubble=!0,a.preventDefault(),!1}function d(a){var b;if(b=E,b&&"function"==typeof b)try{b(a+"\n")}catch(c){window.alert("AQ DEBUG: "+a+" ["+c.message+"]\n")}}function e(a){var b,c,d;return b="",-1!==a.search(".js")&&(c=a.lastIndexOf("/")+1,d=a.substr(c).replace(/^[\s\(\)]+|[\s\(\)]+$/g,""),3===d.split(":").length&&(d=d.substr(0,d.lastIndexOf(":"))),""!==d&&(b+="    "+d+"\n")),b}function f(a){var b,c,d,f;if(console&&console.log&&console.log(a),!a.split)return a;for(b=a.split("\n"),d="",f=b.length,c=0;f>c;c+=1)d+=e(b[c]);return d}function g(b,c){var d;if(C=!0,("string"!=typeof b||b.length<1)&&(b="???"),b="AQ ERROR: "+b+"\n",F&&c&&(b+=f(c.stack)+"\n"),d=E,d&&"function"==typeof d)try{d(b)}catch(e){window.alert(b+" ["+c.message+"]\n")}return a.ERROR}function h(a){try{throw new Error("AQ ERROR")}catch(b){return g(a,b)}}function i(c,d){var e,f,g,i,j;if(e=b(d),"undefined"===e||null===d||d===a.DEFAULT)return I;if("array"!==e)return h(c+".fileTypes not an array");if(f=d.length,1>f)return h(c+".fileTypes array empty");for(i=[],g=0;f>g;g+=1){if(j=d[g],!j||"string"!=typeof j||j.length<1)return h(c+"Invalid .fileType entry @ "+g);j=j.toLowerCase(),I.indexOf(j)>=0&&i.indexOf(j)<0&&i.push(j)}return i.length<1?h(c+"No playable audio types listed"):i}function j(c,d,e){var f,g;if(f=b(e),!e||"undefined"===f)return a.DONE;if("object"!==f)return h(c+"params not an object");if(g=e.path,f=b(g),"undefined"!==f){if(g===a.DEFAULT)g=s.path;else if("string"!==f||g.length<1)return h(c+".path property not a valid string");d.path=g}if(g=i(c,e.fileTypes),g===a.ERROR)return a.ERROR;if(g&&(d.fileTypes=g),g=e.autoplay,f=b(g),"undefined"!==f){if(g!==!0&&g!==!1)if(g===a.DEFAULT)g=s.autoplay;else if(null===g)g=!1;else{if("number"!==f)return h(c+".autoplay property invalid");g=0!==g}d.autoplay=g}if(g=e.lock,f=b(g),"undefined"!==f){if(g!==!0&&g!==!1)if(g===a.DEFAULT)g=s.lock;else if(null===g)g=!1;else{if("number"!==f)return h(c+".lock property invalid");g=0!==g}d.lock=g}if(g=e.volume,f=b(g),"undefined"!==f){if(g===a.DEFAULT)g=s.volume;else{if("number"!==f)return h(c+".volume property not a number");g>q?g=q:0>g&&(g=0)}d.volume=g}if(g=e.loop,f=b(g),"undefined"!==f){if(g!==!0&&g!==!1)if(g===a.DEFAULT)g=s.loop;else if(null===g)g=!1;else{if("number"!==f)return h(c+".loop property invalid");g=0!==g}d.loop=g}if(g=e.start,f=b(g),"undefined"!==f){if(g===a.DEFAULT)g=s.start;else{if("number"!==f)return h(c+".start property not a number");g=Math.floor(g),0>g&&(g=0)}d.start=g}if(g=e.end,f=b(g),"undefined"!==f){if(g===a.DEFAULT)g=s.end;else{if("number"!==f)return h(c+".end property not a number");g=Math.floor(g),0>g&&(g=0)}d.end=g}if(g=e.onLoad,f=b(g),"undefined"!==f){if(g===a.DEFAULT)g=s.onLoad;else if("function"!==f)return h(c+".onLoad property not a function");d.onLoad=g}if(g=e.onPlay,f=b(g),"undefined"!==f){if(g===a.DEFAULT)g=s.onPlay;else if("function"!==f)return h(c+".onPlay property not a function");d.onPlay=g}if(g=e.onEnd,f=b(g),"undefined"!==f){if(g===a.DEFAULT)g=s.onEnd;else if("function"!==f)return h(c+".onEnd property not a function");d.onEnd=g}return g=e.data,f=b(g),"undefined"!==f&&(g===a.DEFAULT&&(g=s.data),d.data=g),a.DONE}function k(a){return{name:a,path:D,fileTypes:I,lock:s.loop,volume:s.volume,start:s.start,end:s.end,loop:s.loop,autoplay:s.autoplay,onLoad:s.onLoad,onPlay:s.onPlay,onEnd:s.onEnd,data:s.data}}var l="AQ",m=1,n=0,o=7,p=!1,q=1,r=32,s={path:"",fileTypes:["ogg","mp3","wav"],autoplay:!1,volume:.5,start:0,end:-1,loop:!1,lock:!1,onLoad:null,onPlay:null,onEnd:null,data:0},t="bf_",u="ch_",v="EMPTY",w="LOADING",x="READY",y="PLAYING",z="PAUSED",A=3,B=!1,C=!1,D="",E=null,F=!1,G=!1,H=!1,I=null,J=!1,K=void 0,L={ogg:{ok:!1,type:'audio/ogg; codecs="vorbis"'},mp3:{ok:!1,type:'audio/mpeg; codecs="mp3"'},wav:{ok:!1,type:'audio/wav; codecs="1"'},aac:{ok:!1,type:'audio/mp4; codecs="mp4a.40.2"'},webm:{ok:!1,type:'audio/webm; codecs="vorbis"'},opus:{ok:!1,type:'audio/ogg; codecs="opus"'}},M=[],N=0,O=0,P=null,Q={context:null,buffers:[],bufferID:0,stopChannel:function(b){var c,e;return c="[AQ._web.stopChannel] ",C?a.ERROR:(p&&d(c+b.id),e=b.source,e&&e.playbackState!==A&&(b.thandle&&window.clearTimeout(b.thandle),void 0!==e.stop?e.stop(0):e.noteOff(0),b.status=x),a.DONE)},assignChannel:function(){var a;return O+=1,a=u+O},playBuffer:function(b,c){var e,f,i,j,k,l,m,n,o,q;if(e="[AQ._web.playBuffer] ",C)return a.ERROR;if(f=Q.context,i=f.createBufferSource(),!i)return h(e+"Invalid bufferSource");if(i.buffer=b.audio,j=void 0!==f.createGain?f.createGain():f.createGainNode(),!j)return h(e+"Invalid gainNode");if(i.connect(j),j.connect(f.destination),j.gain.value=b.params.volume,void 0===c&&(c=0),k=b.audio.duration-c,l=Math.floor(1e3*k),b.channel_id||(b.channel_id=Q.assignChannel()),m=b.channel_id,n={id:m,buffer:b,source:i,gainNode:j,startTime:f.currentTime-c,pauseTime:0,endTime:-1,status:y},n.thandle=window.setTimeout(function(){var a,b,c;for(a=M.length,b=0;a>b;b+=1)if(n=M[b],n.id===m){if(p&&d(e+"Ending "+m+": "+o.pathname),c=n.buffer,o=c.params,q=o.onEnd,q&&"function"==typeof q){p&&d(e+"Calling user .onEnd on "+m+": "+o.pathname);try{q({channel:c.channel_id,name:o.name,path:o.pathname,duration:c.duration,data:o.data})}catch(f){g(e+"User .onEnd failed on "+m+": "+o.pathname+" ["+f.message+"]",f)}}return Q.stopChannel(n),M.splice(b,1),void(o.loop&&Q.playBuffer(c,0))}h(e+"Channel "+m+" not found")},l),M.push(n),void 0!==i.start?i.start(0,c,k):i.noteGrainOn(0,c,k),o=b.params,q=o.onPlay,q&&"function"==typeof q){p&&d(e+"Calling user .onPlay for "+b.channel_id+": "+o.pathname);try{q({channel:b.channel_id,name:o.name,path:o.pathname,duration:b.duration,data:o.data})}catch(r){g(e+"User .onPlay failed on "+b.channel_id+": "+o.pathname+" ["+r.message+"]",r)}}return m},load:function(b){var c,e,f,i,j,k;if(c="[AQ._web.load] ",C)return a.ERROR;for(e=Q.buffers.length,f=0;e>f;f+=1)if(i=Q.buffers[f],i.params.pathname===b.pathname)return p&&d(c+b.pathname+" found in "+i.id),i.channel_id;if(Q.bufferID+=1,j=t+Q.bufferID,i={id:j,channel_id:Q.assignChannel(),audio:null,duration:0,params:b},p&&d(c+"Creating "+i.id+" for "+b.pathname),k=new XMLHttpRequest,!k)return h(c+"XMLHttpRequest error");k.open("GET",b.pathname,!0),k.responseType="arraybuffer",k.onload=function(){p&&d(c+"Loaded "+b.pathname+" into "+i.id),Q.context.decodeAudioData(k.response,function(a){var e;if(i.audio=a,i.duration=Math.floor(1e3*a.duration),Q.buffers.push(i),p&&d(c+"Decoded "+b.pathname+" in "+i.id+" ("+i.duration+" ms)"),e=b.onLoad,e&&"function"==typeof e){b.onLoad=null,p&&d(c+"Calling user .onLoad for "+i.channel_id+": "+b.pathname);try{e({channel:i.channel_id,name:b.name,path:b.pathname,duration:i.duration,data:b.data})}catch(f){g(c+"User .onLoad failed on "+i.channel_id+": "+b.pathname+" ["+f.message+"]",f)}}i.params.autoplay&&(p&&d(c+"Autoplaying "+i.id+" :"+b.pathname),Q.playBuffer(i))},function(){h(c+"Error loading "+b.pathname)})};try{k.send()}catch(l){return g(c+"XMLHttpRequest failed: "+b.pathname+" ["+l.message+"]",l)}return i.channel_id},play:function(b){var c,e,f,g;if(c="[AQ._web.play] ",C)return a.ERROR;for(e=Q.buffers.length,f=0;e>f;f+=1)if(g=Q.buffers[f],g.params.pathname===b.pathname)return p&&d(c+"Found "+b.pathname),Q.playBuffer(g);return p&&d(c+b.pathname+" unavailable; loading"),b.autoplay=!0,Q.load(b)},playChannel:function(b){var c,d,e,f;if(c="[AQ._web.playChannel] ",C)return a.ERROR;for(d=Q.buffers.length,e=0;d>e;e+=1)if(f=Q.buffers[e],f.channel_id===b)return Q.playBuffer(f);return h(c+b+" not found")},pause:function(b){var c,e,f,g,h,i,j;if(c="[AQ._web.pause] ",C)return a.ERROR;for(e=M.length,f=0;e>f;f+=1)if(g=M[f],g.id===b)return h=g.buffer,i=g.source,j=g.pauseTime,j>0&&g.status===z?(M.splice(f,1),Q.playBuffer(h,j)):(g.thandle&&(window.clearTimeout(g.thandle),g.thandle=null),i&&i.playbackState!==A?(j=Q.context.currentTime-g.startTime,j%=h.audio.duration,g.pauseTime=j,g.status=z,void 0!==i.stop?i.stop(0):i.noteOff(0)):M.splice(f,1),b);return p&&d(c+b+" not found"),a.ERROR},stop:function(b){var c,e,f,g;if(c="[AQ._web.stop] ",C)return a.ERROR;for(e=M.length,f=0;e>f;f+=1)if(g=M[f],g.id===b)return Q.stopChannel(g),M.splice(f,1),a.DONE;return p&&d(c+b+" not found"),a.ERROR},init:function(){return C?a.ERROR:(Q.buffers=[],Q.bufferID=0,a.WEB_AUDIO)}},R={onError:function(a){var b,d,e,f,g,i;switch(b="[AQ._html.onError] ",d=a.currentTarget,e=d.getAttribute("data-channel"),e=parseInt(e,10),f=M[e],g=a.target.error.code){case 1:i="Playback aborted";break;case 2:i="Network failure";break;case 3:i="Source decode failed";break;case 4:i="Invalid source file";break;default:i="Unknown"}return h(b+i+" @ "+f.id+": "+f.params.pathname),c(a)},onStalled:function(a){var b,e,f,g;return b="[AQ._html.onStalled] ",p&&(e=a.currentTarget,f=e.getAttribute("data-channel"),f=parseInt(f,10),g=M[f],d(b+g.id+": "+g.params.pathname)),c(a)},startChannel:function(c,e){var f,g,h,i;return f="[AQ._html.startChannel] ",C?a.ERROR:(p&&d(f+"Playing "+c.id),c.status=y,g=c.audio,i=b(e),"object"===i&&(h=e.volume,i=b(h),"undefined"!==i&&(c.params.volume=h,g.volume=h),h=e.loop,i=b(h),"undefined"!==i&&(c.params.loop=h,g.loop=h),h=e.onDone,i=b(h),"undefined"!==i&&(c.params.onDone=h),h=e.userData,i=b(h),"undefined"!==i&&(c.params.userData=h),h=e.lock,i=b(h),"undefined"!==i&&(c.params.lock=h)),g.play(),a.DONE)},onLoad:function(a){var b,e,f,h,i,j,k;if(b="[AQ._html.onLoad] ",e=a.currentTarget,f=e.getAttribute("data-channel"),f=parseInt(f,10),h=M[f],h.status=x,i=h.params,p&&d(b+h.id+": "+i.pathname),j=h.audio,j.removeEventListener("canplaythrough",R.onLoad,!1),h.duration=Math.floor(1e3*j.duration),k=i.onLoad,k&&"function"==typeof k){i.onLoad=null,p&&d(b+"Calling user .onLoad on "+h.id+": "+i.pathname);try{k({channel:h.id,name:i.name,path:i.pathname,duration:h.duration,data:i.data})}catch(l){return g(b+"User .onLoad failed on "+h.id+": "+i.pathname+" ["+l.message+"]",l),c(a)}}return i.autoplay&&(p&&d(b+"Autoplaying "+h.id),i.autoplay=!1,R.startChannel(h,i)),c(a)},onPlay:function(a){var b,e,f,h,i,j;if(b="[AQ._html.onPlay] ",e=a.currentTarget,f=e.getAttribute("data-channel"),f=parseInt(f,10),h=M[f],i=h.params,p&&d(b+h.id+": "+i.pathname+" ("+h.duration+"ms)"),j=i.onPlay,j&&"function"==typeof j){p&&d(b+"Calling user .onPlay on "+h.id+": "+i.pathname);try{j({channel:h.id,name:i.name,path:i.pathname,duration:h.duration,data:i.data})}catch(k){g(b+"User .onPlay failed on "+h.id+": "+i.pathname+" ["+k.message+"]",k)}}return c(a)},onEnd:function(a){var b,e,f,h,i,j;if(b="[AQ._html.onEnd] ",e=a.currentTarget,f=e.getAttribute("data-channel"),f=parseInt(f,10),h=M[f],i=h.params,p&&d(b+h.id+": "+i.pathname),h.status=x,j=i.onEnd,j&&"function"==typeof j){p&&d(b+"Calling user .onEnd on "+h.id+": "+i.pathname);try{j({channel:h.id,name:i.name,path:i.pathname,duration:h.duration,data:i.data})}catch(k){g(b+"User .onEnd failed on "+h.id+": "+i.pathname+" ["+k.message+"]",k)}}return c(a)},loadChannel:function(b,c){var e,f;return e="[AQ._html.loadChannel] ",C?a.ERROR:(b.params=c,b.status=w,f=b.audio,f.addEventListener("canplaythrough",R.onLoad,!1),f.preload="auto",f.volume=c.volume,f.loop=c.loop,p&&d(e+b.id+": "+c.pathname),f.setAttribute("src",c.pathname),a.DONE)},load:function(b){var c,e,f,g;if(c="[AQ._html.load] ",C)return a.ERROR;for(e=0;N>e;e+=1)if(f=M[e],f.params.pathname===b.pathname&&f.status===x)return p&&d(c+f.id+" ready: "+b.pathname),f.audio.currentTime=0,b.autoplay&&R.startChannel(f,b),f.id;for(e=0;r>e;e+=1)if(f=M[e],f.status===v)return p&&d(c+f.id+" available"),g=e+1,g>N&&(N=g),R.loadChannel(f,b),f.id;for(e=0;N>e;e+=1)if(f=M[e],!f.params.lock&&f.status===x)return p&&d(c+f.id+" hijacked: "+b.pathname),f.audio.currentTime=0,R.loadChannel(f,b),f.id;return p&&d(c+"No channel available: "+b.pathname),a.ERROR},play:function(b){var c,e,f;if(c="[AQ._html.play] ",C)return a.ERROR;for(e=0;N>e;e+=1)if(f=M[e],f.params.pathname===b.pathname&&f.status===x)return p&&d(c+f.id+" ready: "+b.pathname),f.audio.currentTime=0,R.startChannel(f,b),f.id;return p&&d(c+b.pathname+" unavailable; loading"),b.autoplay=!0,R.load(b)},playChannel:function(b){var c,e,f;if(c="[AQ._html.playChannel] ",C)return a.ERROR;for(e=0;N>e;e+=1)if(f=M[e],f.id===b)return p&&d(c+"Found "+b),f.status!==x?h(c+b+" not ready"):(f.audio.currentTime=0,R.startChannel(f),f.id);return h(c+b+" not found")},pause:function(b){var c,e,f;if(c="[AQ._html.pause] ",C)return a.ERROR;for(e=0;N>e;e+=1)if(f=M[e],f.id===b)return f.status===z?R.startChannel(f):f.status===y&&(f.status=z,f.audio.pause()),b;return p&&d(c+b+" not found"),a.ERROR},stop:function(b){var c,e,f,g;if(c="[AQ._html.stop] ",C)return a.ERROR;for(e=0;N>e;e+=1)if(f=M[e],f.id===b)return f.params.autoplay=!1,g=f.status,(g===y||g===z)&&(f.status=x,f.audio.pause(),f.audio.currentTime=0),a.DONE;return p&&d(c+b+" not found"),a.ERROR},init:function(){var b,c,d;if(b="[AQ._html.init] ",C)return a.ERROR;for(M.length=r,c=0;r>c;c+=1){if(d=document.createElement("audio"),!d)return h(b+"element init failed");d.setAttribute("data-channel",c.toString()),d.addEventListener("error",R.onError,!1),d.addEventListener("stalled",R.onStalled,!1),d.addEventListener("play",R.onPlay,!1),d.addEventListener("ended",R.onEnd,!1),document.body.appendChild(d),M[c]={id:u+(c+1),audio:d,duration:0,params:null,status:v}}return a.HTML5_AUDIO}};return a={ERROR:"AQ.ERROR",DONE:"AQ.DONE",DEFAULT:"AQ.DEFAULT",HTML5_AUDIO:"AQ.HTML5_AUDIO",WEB_AUDIO:"AQ.WEB_AUDIO",init:function(c){var e,f,g,h,j,k,q,r,t,u,v;if(e="[AQ.init] ",J)return K;if(f={engine:l,major:m,minor:n,revision:o,status:a.ERROR,fileTypes:[]},B=!1,C=!1,D=s.path,E=null,F=!1,H=!1,g=document.createElement("audio"),h=g.canPlayType,!h)return window.alert(e+"Audio codec testing not available\n"),f;I=[];for(j in L)L.hasOwnProperty(j)&&(k=L[j],q=g.canPlayType(k.type),("probably"===q||"maybe"===q)&&(k.ok=!0,I.push(j)));if(g=null,I.length<1)return window.alert(e+"No common audio filetypes supported\n"),f;if(c){if("object"!=typeof c)return window.alert(e+"Invalid parameter\n"),f;if(r=c.onAlert,t=b(r),"undefined"!==t){if(null===r||r===a.DEFAULT)r=null;else if("function"!==t)return window.alert(e+".onAlert property not a function"),f;E=r}if(r=c.stack,t=b(r),"undefined"!==t){if(r&&r!==a.DEFAULT){if(r!==!0&&"number"===t)return window.alert(e+".stack property not a boolean"),f;r=!0}else r=!1;F=r}if(r=c.forceHTML5,t=b(r),"undefined"!==t){if(r!==!0&&r!==!1)if(r===a.DEFAULT)r=!1;else{if("number"!==t)return window.alert(e+".forceHTML5 property invalid"),f;r=0!==r}p&&d("_forceHTML5 = "+r),H=r}if(r=c.defaultPath,t=b(r),"undefined"!==t){if(null===r||r===a.DEFAULT)r=s.path;else if("string"!==t)return window.alert(e+".defaultPath property not a valid string"),f;D=r}if(r=i(e,c.defaultFileTypes),r===a.ERROR)return f;r&&(I=r)}if(M.length=0,N=0,O=0,Q.context=null,G=!1,!H&&(v=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.oAudioContext||window.msAudioContext)){if(Q.context=new v,!Q.context)return window.alert(e+"AudioContext init failed"),f;G=!0}if(G)P=Q;else{if(!h)return window.alert(e+"HTML5 Audio not supported"),f;P=R}return u=P.init(),u!==a.ERROR&&(B=!0),p&&d(e+"status = "+u),f.status=a.DONE,f.fileTypes=I,J=!0,K=f,f},load:function(b,c){var e,f,g;return B?(e="[AQ.load] ",!b||"string"!=typeof b||b.length<1?h(e+"name parameter invalid"):(f=k(b),j(e,f,c)===a.ERROR?a.ERROR:(f.pathname=f.path+f.name+"."+f.fileTypes[0],g=P.load(f),p&&d(e+"Loaded "+f.pathname+", result = "+g),g))):a.ERROR},play:function(b,c){var e,f,g;return B?(e="[AQ.play] ",!b||"string"!=typeof b||b.length<1?h(e+"name parameter invalid"):(f=k(b),j(e,f,c)===a.ERROR?a.ERROR:(f.pathname=f.path+f.name+"."+f.fileTypes[0],g=P.play(f),p&&d(e+"Played "+f.pathname+", result = "+g),g))):a.ERROR},playChannel:function(b){var c,e;return B?(c="[AQ.playChannel] ",!b||"string"!=typeof b||b.length<1?h(c+"Invalid channel id"):(e=P.playChannel(b),p&&d(c+"Played "+b+", result = "+e),e)):a.ERROR},pause:function(b){var c,e;return B?(c="[AQ.pause] ",!b||"string"!=typeof b||b.length<1?h(c+"Invalid channel id"):(e=P.pause(b),p&&d(c+"Paused "+b+", result = "+e),e)):a.ERROR},stop:function(b){var c,e;return B?(c="[AQ.stop] ",!b||"string"!=typeof b||b.length<1?h(c+"Invalid channel id"):(e=P.stop(b),p&&d(c+"Stopped "+b+", result = "+e),e)):a.ERROR}}}(AQ||{});