/*! Perlenspiel 3.2.1 2014-12-16 */
"function"!=typeof Object.create&&(Object.create=function(a){"use strict";function b(){}return b.prototype=a,new b}),function(){"use strict";var a,b,c,d;for(a=0,b=["webkit","moz","ms","o"],c=0;c<b.length&&!window.requestAnimationFrame;c+=1)d=b[c],window.requestAnimationFrame=window[d+"RequestAnimationFrame"],window.cancelAnimationFrame=window[d+"CancelAnimationFrame"]||window[d+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b){var c,d,e;return c=(new Date).getTime(),d=Math.max(0,16-(c-a)),e=window.setTimeout(function(){b(c+d)},d),a=c+d,e}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){window.clearTimeout(a)})}(),function(){"use strict";String.fromCodePoint||(String.fromCodePoint=function(){var a,b,c,d,e;for(a=[],b=0;b<arguments.length;b+=1)c=arguments[b],d=c-65536,e=c>65535?[55296+(d>>10),56320+(1023&d)]:[c],a.push(String.fromCharCode.apply(null,e));return a.join("")})}();var PS=PS||{},PERLENSPIEL=function(a){"use strict";var b=[],c=[],d=[],e=!0;return a.RegisterModule=function(a){if("function"==typeof a&&b.push(a),c.length>0)for(var d=0;d<c.length;++d)a.call(null,c[d].engine)},a.Create=function(a){for(var d={},e=0;e<b.length;++e)b[e].call(null,d);var f=d.Create(a);return c.push(f),f.ps},a.AutoStartEnabled=function(){return e},a.EnableAutoStart=function(a){e=a},a.OnStartInstance=function(a){d.push(a)},a.OnStopInstance=function(a){var b=d.indexOf(a);b>0&&d.splice(b,1)},a.Broadcast=function(a,b){for(var c=0;c<d.length;++c)d[c].broadcast(a,b)},a.NumInstances=function(){return c.length},a}(PERLENSPIEL||{}),PerlenspielCore=function(a){"use strict";return a.Create=function(b){return a.instance=new a.PSInterface(b),a._psObject={engine:a,ps:a.instance,broadcast:a._onBroadcast,started:!1},a._psObject},a.PSInterface=function(b){a._initializeModules(b),this.setOptions(b)},a._initQueue=[],a._startQueue=[],a._spec={},a._isInitialized=!1,a._onInit=function(b){"function"==typeof b?a._isInitialized?b.call(null,a._spec):a._initQueue.push(b):console.error("_onInit func was type "+typeof b+" instead of a function.")},a._initializeModules=function(b){a._spec=b;for(var c=0;c<a._initQueue.length;++c)a._initQueue[c].call(null,a._spec);a._isInitialized=!0},a._onStart=function(b){"function"==typeof b?a._startQueue.push(b):console.error("_onStart func was type "+typeof b+" instead of a function.")},a._startModules=function(){for(var b=0;b<a._startQueue.length;++b)a._startQueue[b].call(null,a._spec,a.instance)},a};PERLENSPIEL.RegisterModule(PerlenspielCore);var PerlenspielConstants=function(a){"use strict";return a._onInit(function(){a.provideConstants(PS)}),a.provideConstants=function(a){a.ALL="PS.ALL",a.CURRENT="PS.CURRENT",a.DONE="PS.DONE",a.DEFAULT="PS.DEFAULT",a.ERROR="PS.ERROR",a.EMPTY="PS.EMPTY",a.UNEQUAL="PS.UNEQUAL",a.GRID="PS.GRID",a.HTML5_AUDIO="PS.HTML5_AUDIO",a.WEB_AUDIO="PS.WEB_AUDIO",a.SPRITE_TOUCH="PS.SPRITE_TOUCH",a.SPRITE_OVERLAP="PS.SPRITE_OVERLAP",a.COLOR_BLACK=0,a.COLOR_WHITE=16777215,a.COLOR_GRAY_LIGHT=12632256,a.COLOR_GRAY=8421504,a.COLOR_GRAY_DARK=4210752,a.COLOR_RED=16711680,a.COLOR_ORANGE=16744448,a.COLOR_YELLOW=16776960,a.COLOR_GREEN=65280,a.COLOR_BLUE=255,a.COLOR_INDIGO=4194559,a.COLOR_VIOLET=8388863,a.COLOR_MAGENTA=16711935,a.COLOR_CYAN=65535,a.ALPHA_OPAQUE=255,a.ALPHA_TRANSPARENT=0,a.KEY_ENTER=13,a.KEY_TAB=9,a.KEY_ESCAPE=27,a.KEY_ARROW_LEFT=1005,a.KEY_ARROW_UP=1006,a.KEY_ARROW_RIGHT=1007,a.KEY_ARROW_DOWN=1008,a.KEY_INSERT=1009,a.KEY_DELETE=1010,a.KEY_PAD_0=96,a.KEY_PAD_1=97,a.KEY_PAD_2=98,a.KEY_PAD_3=99,a.KEY_PAD_4=100,a.KEY_PAD_5=101,a.KEY_PAD_6=102,a.KEY_PAD_7=103,a.KEY_PAD_8=104,a.KEY_PAD_9=105,a.KEY_F1=112,a.KEY_F2=113,a.KEY_F3=114,a.KEY_F4=115,a.KEY_F5=116,a.KEY_F6=117,a.KEY_F7=118,a.KEY_F8=119,a.KEY_F9=120,a.KEY_F10=121,a.WHEEL_FORWARD="PS.WHEEL_FORWARD",a.WHEEL_BACKWARD="PS.WHEEL_BACKWARD",a.FINDER_ASTAR="PS.FINDER_ASTAR",a.FINDER_BREADTH_FIRST="PS.FINDER_BREADTH_FIRST",a.FINDER_BEST_FIRST="PS.FINDER_BEST_FIRST",a.FINDER_DIJKSTRA="PS.FINDER_DIJKSTRA",a.FINDER_BI_ASTAR="PS.FINDER_BI_ASTAR",a.FINDER_BI_BEST_FIRST="PS.FINDER_BI_BEST_FIRST",a.FINDER_BI_DIJKSTRA="PS.FINDER_BI_DIJKSTRA",a.FINDER_BI_BREADTH_FIRST="PS.FINDER_BI_BREADTH_FIRST",a.FINDER_JUMP_POINT="PS.FINDER_JUMP_POINT",a.DEFAULT_NAMESPACE="game"},a._setNamespace=function(b){a._NAMESPACE=b,a._OUTER_ID=a._NAMESPACE+"-"+a._OUTER_CLASS,a._MAIN_ID=a._NAMESPACE+"-"+a._MAIN_CLASS,a._DEBUG_ID=a._NAMESPACE+"-"+a._DEBUG_CLASS,a._STATUS_P_ID=a._NAMESPACE+"-"+a._STATUS_P_CLASS,a._INPUT_P_ID=a._NAMESPACE+"-"+a._INPUT_P_CLASS,a._INPUT_LABEL_ID=a._NAMESPACE+"-"+a._INPUT_LABEL_CLASS,a._INPUT_SPAN_ID=a._NAMESPACE+"-"+a._INPUT_SPAN_CLASS,a._INPUT_BOX_ID=a._NAMESPACE+"-"+a._INPUT_BOX_CLASS,a._GRID_ID=a._NAMESPACE+"-"+a._GRID_CLASS,a._FOOTER_ID=a._NAMESPACE+"-"+a._FOOTER_CLASS,a._MONITOR_ID=a._NAMESPACE+"-"+a._MONITOR_CLASS},a._OUTER_CLASS="outer",a._MAIN_CLASS="main",a._DEBUG_CLASS="debug",a._STATUS_P_CLASS="stsp",a._INPUT_P_CLASS="inp",a._INPUT_LABEL_CLASS="inlabel",a._INPUT_SPAN_CLASS="inspan",a._INPUT_BOX_CLASS="inbox",a._GRID_CLASS="grid",a._FOOTER_CLASS="footer",a._MONITOR_CLASS="monitor",a._LOGIN_ID="login",a._LOGIN_EMAIL_ID="login_em",a._LOGIN_PW1_ID="login_pw1",a._LOGIN_PW2_ID="login_pw2",a._LOGIN_BUT_ID="login_but",a._LOGIN_SIGNUP_ID="login_su",a._LOGIN_RECOVER_ID="login_re",a._IMAGE_PREFIX="image_",a._SPRITE_PREFIX="sprite_",a._PATHMAP_PREFIX="pathmap_",a._TIMER_PREFIX="timer_",a._MAX_GRID_SIZE=512,a._MAX_FONT_SIZE=1.25,a._MAX_SHADOW_SIZE=8,a._MAX_BLUR_SIZE=64,a._ALPHOID=1/255,a._RSHIFT=65536,a._GSHIFT=256,a._MAX_BEADS=1024,a._EMPTY={},a._DEFAULT_KEY_DELAY=6,a._KEY_SHIFT=16,a._KEY_CTRL=17,a._CLEAR=-1,a._FADER_FPS=4,a._DIAGONAL_COST=1.4142,a._LABEL_MAX=16,a._PIANO_FILES=["a0","bb0","b0","c1","db1","d1","eb1","e1","f1","gb1","g1","ab1","a1","bb1","b1","c2","db2","d2","eb2","e2","f2","gb2","g2","ab2","a2","bb2","b2","c3","db3","d3","eb3","e3","f3","gb3","g3","ab3","a3","bb3","b3","c4","db4","d4","eb4","e4","f4","gb4","g4","ab4","a4","bb4","b4","c5","db5","d5","eb5","e5","f5","gb5","g5","ab5","a5","bb5","b5","c6","db6","d6","eb6","e6","f6","gb6","g6","ab6","a6","bb6","b6","c7","db7","d7","eb7","e7","f7","gb7","g7","ab7","a7","bb7","b7","c8"],a._HCHORD_FILES=["a2","bb2","b2","c3","db3","d3","eb3","e3","f3","gb3","g3","ab3","a3","bb3","b3","c4","db4","d4","eb4","e4","f4","gb4","g4","ab4","a4","bb4","b4","c5","db5","d5","eb5","e5","f5","gb5","g5","ab5","a5","bb5","b5","c6","db6","d6","eb6","e6","f6","gb6","g6","ab6","a6","bb6","b6","c7","db7","d7","eb7","e7","f7"],a._XYLO_FILES=["a4","bb4","b4","c5","db5","d5","eb5","e5","f5","gb5","g5","ab5","a5","bb5","b5","c6","db6","d6","eb6","e6","f6","gb6","g6","ab6","a6","bb6","b6","c7","db7","d7","eb7","e7","f7","gb7","g7","ab7","a7","bb7","b7"],a._DEFAULTS={grid:{width:512,x:8,y:8,max:32,plane:0,color:{r:255,g:255,b:255,a:255,rgb:16777215,str:"rgba(255,255,255,1)"},shadow:{show:!1,r:192,g:192,b:192,a:255,rgb:12632256,str:"rgba(192,192,192,1)",params:"0px 0px 64px 8px "},padLeft:0,padRight:0,ready:!1},status:{text:"",label:"",exec:null,color:{r:0,g:0,b:0,a:255,rgb:0,str:"rgba(0,0,0,1)"}},fader:{active:!1,kill:!1,r:0,g:0,b:0,rgb:null,tr:0,tg:0,tb:0,trgb:0,tstr:null,step:0,rate:0,onStep:null,onEnd:null,params:null},bead:{dirty:!0,active:!0,visible:!0,planes:null,color:{r:255,g:255,b:255,a:255,rgb:16777215,str:"rgba(255,255,255,1)"},bgColor:{r:255,g:255,b:255,a:0,rgb:16777215,str:"rgba(255,255,255,0)"},radius:0,scale:100,data:0,exec:null,border:{width:1,equal:!0,top:1,left:1,bottom:1,right:1,color:{r:128,g:128,b:128,a:255,rgb:8421504,str:"rgba(128,128,128,1)"}},glyph:{str:"",code:0,scale:100,size:0,x:0,y:0,font:null,color:{r:0,g:0,b:0,a:255,rgb:0,str:"rgba(0,0,0,1)"}}},audio:{volume:.5,max_volume:1,path:"http://alpheus.wpi.edu/~bmoriarty/ps/audio/",loop:!1,error_sound:"fx_uhoh"}},a};PERLENSPIEL.RegisterModule(PerlenspielConstants);var PerlenspielStartup=function(a){"use strict";return a.PSInterface.prototype.start=function(){a._sys(),a._psObject.started=!0,PERLENSPIEL.OnStartInstance(a._psObject),a._startModules()},a.PSInterface.prototype.shutdown=function(){a._clockActive=!1,a._psObject.started=!1,PERLENSPIEL.OnStopInstance(a._psObject),a._gridDeactivate()},a.PSInterface.prototype.setOptions=function(b){a._options=b||{namespace:PS.DEFAULT_NAMESPACE,requireEvents:!0,forceMulti:!1},a._setNamespace(a._options.namespace||PS.DEFAULT_NAMESPACE),a._lastTick=0,a.provideConstants(this),a._optionsSet=!0},a._sys=function(){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t;for(b="[PS.sys] ",a._RSTR=[],a._RSTR.length=256,a._GBSTR=[],a._GBSTR.length=256,a._BASTR=[],a._BASTR.length=256,a._ASTR=[],a._ASTR.length=256,c=0;256>c;c+=1)a._RSTR[c]="rgba("+c+",",a._GBSTR[c]=c+",",a._BASTR[c]=c+",1)",p=Math.floor(a._ALPHOID*c*1e3)/1e3,a._ASTR[c]=p+")";if(a._systemDetect(),a._sizeDetect(),a._touchScreen=a._hasTouch(),a._system.inputs.touch=a._touchScreen,document.body.id="body",a._isMultiMode()||(document.body.style.backgroundColor=a._DEFAULTS.grid.color.str),d=document.getElementById(a._NAMESPACE),!d&&(d=document.createElement("div"),document.body.appendChild(d),!d))return console.error("No outer div!");if(d.id=a._OUTER_ID,d.tabindex=12,d.className=a._OUTER_CLASS,d.style.backgroundColor=a._DEFAULTS.grid.color.str,a._main=document.createElement("div"),!a._main)return console.error("No main div!");if(a._main.id=a._MAIN_ID,a._main.className=a._MAIN_CLASS,a._main.style.width=a._gridMax+"px",d.appendChild(a._main),f=document.createElement("p"),f.id=a._STATUS_P_ID,f.className=a._STATUS_P_CLASS,f.style.fontSize=a._fontMax,f.style.whiteSpace="nowrap",f.style.display="block",g=document.createTextNode("."),f.appendChild(g),a._main.appendChild(f),h=document.createElement("p"),h.id=a._INPUT_P_ID,h.className=a._INPUT_P_CLASS,h.style.fontSize=a._fontMax,h.style.display="none",j=document.createElement("span"),j.id=a._INPUT_LABEL_ID,j.className=a._INPUT_LABEL_CLASS,i=document.createTextNode(""),j.appendChild(i),h.appendChild(j),j=document.createElement("span"),j.id=a._INPUT_SPAN_ID,j.className=a._INPUT_SPAN_CLASS,k=document.createElement("input"),k.id=a._INPUT_BOX_ID,k.className=a._INPUT_BOX_CLASS,k.type="text",k.tabindex=0,k.wrap="soft",j.appendChild(k),h.appendChild(j),a._main.appendChild(h),a._status={statusP:f,statusNode:g,inputP:h,inputNode:i,input:k,fader:a._newFader(a._STATUS_P_ID,a._statusRGB,null)},a._copy(a._DEFAULTS.status,a._status),a._statusOut("Perlenspiel "+a._system.major+"."+a._system.minor),l=document.createElement("canvas"),!l)return void window.alert(b+"HTML5 canvas not supported.");if(l.id=a._GRID_ID,l.className=a._GRID_CLASS,l.width=a._gridMax,l.style.backgroundColor=a._DEFAULTS.grid.color.str,l.style.boxShadow="none",l.tabIndex="1",a._overGrid=!1,a._resetCursor(),a._main.appendChild(l),m=document.createElement("p"),!m)return console.error("No footer p!");if(m.id=a._FOOTER_ID,m.className=a._FOOTER_CLASS,m.style.opacity="1.0",m.innerHTML="Loading Perlenspiel",a._main.appendChild(m),a._footer=m,e=document.createElement("div"),!e)return console.error("No debug div!");if(e.id=a._DEBUG_ID,e.className=a._DEBUG_CLASS,a._main.appendChild(e),n=document.createElement("textarea"),!n)return console.error("No monitor textarea!");for(n.id=a._MONITOR_ID,n.className=a._MONITOR_CLASS,n.rows=8,n.wrap="soft",n.readonly="readonly",n.onfocus=function(){a._debugFocus=!0},n.onblur=function(){a._debugFocus=!1},e.appendChild(n),a._debugging=!1,a._debugFocus=!1,a._keysActive=!1,a._pressed=[],a._transKeys=[],a._shiftedKeys=[],a._unshiftedKeys=[],c=0;256>c;c+=1)a._pressed[c]=0,a._transKeys[c]=c,a._shiftedKeys[c]=c,a._unshiftedKeys[c]=c;for(a._holding=[],a._holdShift=!1,a._holdCtrl=!1,a._holdAlt=!1,a._keyRepeat=!0,a._keyDelayRate=a._DEFAULT_KEY_DELAY,a._keyInitRate=5*a._DEFAULT_KEY_DELAY,a._transKeys[33]=PS.KEY_PAGE_UP,a._transKeys[34]=PS.KEY_PAGE_DOWN,a._transKeys[35]=PS.KEY_END,a._transKeys[36]=PS.KEY_HOME,a._transKeys[37]=PS.KEY_ARROW_LEFT,a._transKeys[38]=PS.KEY_ARROW_UP,a._transKeys[39]=PS.KEY_ARROW_RIGHT,a._transKeys[40]=PS.KEY_ARROW_DOWN,a._transKeys[45]=PS.KEY_INSERT,a._transKeys[46]=PS.KEY_DELETE,a._transKeys[188]=44,a._transKeys[190]=46,a._transKeys[191]=47,a._transKeys[192]=96,a._transKeys[219]=91,a._transKeys[220]=92,a._transKeys[221]=93,a._transKeys[222]=39,a._shiftedKeys[96]=126,a._shiftedKeys[49]=33,a._shiftedKeys[50]=64,a._shiftedKeys[51]=35,a._shiftedKeys[52]=36,a._shiftedKeys[53]=37,a._shiftedKeys[54]=94,a._shiftedKeys[55]=38,a._shiftedKeys[56]=42,a._shiftedKeys[57]=40,a._shiftedKeys[48]=41,a._shiftedKeys[45]=95,a._shiftedKeys[61]=43,a._shiftedKeys[91]=123,a._shiftedKeys[93]=125,a._shiftedKeys[92]=124,a._shiftedKeys[59]=58,a._shiftedKeys[39]=34,a._shiftedKeys[44]=60,a._shiftedKeys[46]=62,a._shiftedKeys[47]=63,c=65;91>c;c+=1)a._unshiftedKeys[c]=c+32;a._unshiftedKeys[126]=96,a._unshiftedKeys[33]=49,a._unshiftedKeys[64]=50,a._unshiftedKeys[35]=51,a._unshiftedKeys[36]=52,a._unshiftedKeys[37]=53,a._unshiftedKeys[94]=54,a._unshiftedKeys[38]=55,a._unshiftedKeys[42]=56,a._unshiftedKeys[40]=57,a._unshiftedKeys[41]=48,a._unshiftedKeys[95]=45,a._unshiftedKeys[43]=51,a._unshiftedKeys[123]=91,a._unshiftedKeys[125]=93,a._unshiftedKeys[124]=92,a._unshiftedKeys[58]=59,a._unshiftedKeys[34]=39,a._unshiftedKeys[60]=44,a._unshiftedKeys[62]=46,a._unshiftedKeys[63]=47,window.onblur=a._keyReset(),o=l.getContext("2d"),o.constructor.prototype.fillRoundedRect||(o.constructor.prototype.fillRoundedRect=function(b,c,d,e,f,g,h){void 0===f&&(f=5),this.beginPath(),"Opera"===a._system.host.app?(this.moveTo(b+d-f,c),this.arcTo(b+f,c,b,c+f,f),this.arcTo(b,c+e-f,b+f,c+e,f),this.arcTo(b+d-f,c+e,b+d,c+e-f,f),this.arcTo(b+d,c+f,b+d-f,c,f)):(this.moveTo(b+f,c),this.arcTo(b+d,c,b+d,c+e,f),this.arcTo(b+d,c+e,b,c+e,f),this.arcTo(b,c+e,b,c,f),this.arcTo(b,c,b+d,c,f)),this.closePath(),h&&this.stroke(),(g||void 0===g)&&this.fill()}),a._grid={canvas:l,context:o,fader:a._newFader(a._GRID_ID,a._gridRGB,a._gridRGBEnd),focused:!1},a._copy(a._DEFAULTS.grid,a._grid);var u=window.getComputedStyle(a._grid.canvas,null);for(a._grid.padLeft=parseInt(u.getPropertyValue("padding-top").replace("px",""),10),a._grid.padRight=parseInt(u.getPropertyValue("padding-left").replace("px",""),10),a._beads=[],a._beads.length=p=a._MAX_BEADS,c=0;p>c;c+=1)q={index:c,fader:a._newFader(c,a._beadRGBA,null),borderFader:a._newFader(c,a._borderRGBA,null),glyphFader:a._newFader(c,a._glyphRGBA,null)},a._resetBead(q),a._beads[c]=q;if(a._sprites=[],a._spriteCnt=0,a._pathmaps=[],a._pathmapCnt=0,r=null,"iOS"!==a._system.host.os){if(r=AQ.init({defaultPath:a._DEFAULTS.audio.path,defaultFileTypes:["ogg","mp3","wav"],onAlert:a.instance.debug,stack:!0,forceHTML5:!0}),r===PS.ERROR||r.status===AQ.ERROR)return;a._system.audio=r,a._errorSound=null,s=a.instance.audioLoad(a._DEFAULTS.audio.error_sound,{path:a._DEFAULTS.audio.path,lock:!0}),s===PS.ERROR?a._warning("Error sound '"+a._DEFAULTS.audio.error_sound+"' not loaded"):a._errorSound=a._DEFAULTS.audio.error_sound}a._imageCanvas=document.createElement("canvas"),o=a._imageCanvas.getContext("2d"),o.imageSmoothingEnabled=!1,o.mozImageSmoothingEnabled=!1,o.webkitImageSmoothingEnabled=!1,a._imageList=[],a._imageCnt=0,t="() event function undefined","function"!=typeof a.instance.init&&(a.instance.init=null,a._warning("PS.init"+t)),a._options.requireEvents===!0?("function"!=typeof a.instance.touch&&(a.instance.touch=null,a._warning("PS.touch"+t)),"function"!=typeof a.instance.release&&(a.instance.release=null,a._warning("PS.release"+t)),"function"!=typeof a.instance.enter&&(a.instance.enter=null,a._warning("PS.enter"+t)),"function"!=typeof a.instance.exit&&(a.instance.exit=null,a._warning("PS.exit()"+t)),"function"!=typeof a.instance.exitGrid&&(a.instance.exitGrid=null,a._warning("PS.exitGrid"+t)),"function"!=typeof a.instance.keyDown&&(a.instance.keyDown=null,a._warning("PS.keyDown"+t)),"function"!=typeof a.instance.keyUp&&(a.instance.keyUp=null,a._warning("PS.keyUp"+t)),"function"!=typeof a.instance.input&&(a.instance.input=null,a._warning("PS.input"+t))):(a.instance.touch=a.instance.touch||function(){},a.instance.release=a.instance.release||function(){},a.instance.enter=a.instance.enter||function(){},a.instance.exit=a.instance.exit||function(){},a.instance.exitGrid=a.instance.exitGrid||function(){},a.instance.keyDown=a.instance.keyDown||function(){},a.instance.keyUp=a.instance.keyUp||function(){},a.instance.input=a.instance.input||function(){}),t="PS "+a._system.major+"."+a._system.minor+"."+a._system.revision+" | ",r&&(t+=r.engine+" "+r.major+"."+r.minor+"."+r.revision+" | "),t+=a._system.host.os+" "+a._system.host.app+" "+a._system.host.version,a._touchScreen&&(t+=" | Touch "),m.innerHTML=t,a._gridSize(a._DEFAULTS.grid.x,a._DEFAULTS.grid.y),a._initFaders(),a._initTimers(),a._clockActive=!0,a._clock(),a._gridActivate(),a._footerTimer=a.instance.timerStart(6,a._footerFade),a.instance.init&&a._tryInit()},a._tryInit=function(){try{a.instance.init(a._system,a._EMPTY),a._gridDraw()}catch(b){a._errorCatch("PS.init() failed ["+b.message+"]",b)}},a._clock=function(){a._clockActive&&(window.requestAnimationFrame(a._clock),a._tick())},a};PERLENSPIEL.RegisterModule(PerlenspielStartup);var PerlenspielInterface=function(a){"use strict";return a.PSInterface.prototype.gridSize=function(b,c){var d,e,f,g;if(d="[PS.gridSize] ",PS.ERROR===a._checkNumArgs(d,arguments.length,0,2))return PS.ERROR;if(e=b,f=c,g=a._DEFAULTS.grid.max,e===PS.DEFAULT)e=a._DEFAULTS.grid.x;else if(e===PS.CURRENT)e=a._grid.x;else{if("number"!==a._typeOf(e))return a._error(d+"x argument invalid");e=Math.floor(e),1>e?e=1:e>g&&(e=g)}if(f===PS.DEFAULT)f=a._DEFAULTS.grid.y;else if(f===PS.CURRENT)f=a._grid.y;else{if("number"!==a._typeOf(f))return a._error(d+"y argument invalid");f=Math.floor(f),1>f?f=1:f>g&&(f=g)}return a._gridSize(e,f),{width:a._grid.x,height:a._grid.y}},a.PSInterface.prototype.gridPlane=function(b){var c,d,e;if(c="[PS.gridPlane] ",PS.ERROR===a._checkNumArgs(c,arguments.length,0,1))return PS.ERROR;if(d=b,e=a._typeOf(d),"undefined"!==e&&d!==PS.CURRENT){if(d===PS.DEFAULT)d=0;else{if("number"!==e)return a._error(c+"plane argument invalid");d=Math.floor(d),1>d&&(d=0)}a._grid.plane=d}return a._grid.plane},a.PSInterface.prototype.gridColor=function(b,c,d){var e,f;return e="[PS.gridColor] ",PS.ERROR===a._checkNumArgs(e,arguments.length,0,3)||2===arguments.length?PS.ERROR:(f=a._decodeColors(e,b,c,d),f===PS.ERROR?PS.ERROR:a._gridColor(f))},a.PSInterface.prototype.gridFade=function(b,c){var d,e,f,g,h,i,j,k;if(d="[PS.gridFade] ",PS.ERROR===a._checkNumArgs(d,arguments.length,0,2))return PS.ERROR;if(f=a._grid.color,e=a._grid.fader,g=e.rate,j=a._typeOf(b),"undefined"===j||b===PS.CURRENT)h=g;else if(b===PS.DEFAULT)h=a._DEFAULTS.fader.rate;else{if("number"!==j)return a._error(d+"rate argument invalid");h=Math.floor(b),0>h&&(h=0)}return i=a._validFadeOptions(d,c),i===PS.ERROR?PS.ERROR:(k=i.rgb,k!==PS.CURRENT&&(e.rgb=k===PS.DEFAULT?a._DEFAULTS.fader.rgb:k,e.r=i.r,e.g=i.g,e.b=i.b),k=i.onStep,k!==PS.CURRENT&&(e.onStep=k===PS.DEFAULT?a._DEFAULTS.fader.onStep:k),k=i.onEnd,k!==PS.CURRENT&&(e.onEnd=k===PS.DEFAULT?a._DEFAULTS.fader.onEnd:k),k=i.params,k!==PS.CURRENT&&(e.params=k===PS.DEFAULT?a._DEFAULTS.fader.params:k),g!==h&&(e.rate=h,1>h?(e.active=!1,e.kill=!0):e.active&&a._recalcFader(e,f.r,f.g,f.b,255)),{rate:e.rate,rgb:e.rgb,onStep:e.onStep,onEnd:e.onEnd,params:e.params})},a.PSInterface.prototype.gridShadow=function(b,c,d,e){var f,g,h;if(f="[PS.gridShadow] ",PS.ERROR===a._checkNumArgs(f,arguments.length,0,4))return PS.ERROR;if(g=b,g!==!0&&g!==!1&&g!==PS.CURRENT)if(null===g||g===PS.DEFAULT)g=!1;else{if("number"!==a._typeOf(g))return a._error(f+"First argument invalid");g=0!==g}return h=a._decodeColors(f,c,d,e),h===PS.ERROR?PS.ERROR:a._gridShadow(g,h)},a.PSInterface.prototype.gridRefresh=function(){var b="[PS.gridRefresh] ";return PS.ERROR===a._checkNumArgs(b,arguments.length,0,0)?PS.ERROR:(a._gridDraw(),a._refreshed)},a.PSInterface.prototype.color=function(b,c,d,e,f){var g,h;return g="[PS.color] ",PS.ERROR===a._checkNumArgs(g,arguments.length,2,5)?PS.ERROR:(h=a._decodeColors(g,d,e,f),h===PS.ERROR?PS.ERROR:a._beadExec(g,a._color,b,c,h))},a.PSInterface.prototype.alpha=function(b,c,d){var e,f,g;if(e="[PS.alpha] ",PS.ERROR===a._checkNumArgs(e,arguments.length,2,3))return PS.ERROR;if(f=d,f!==PS.CURRENT)if(g=a._typeOf(f),"undefined"===g)f=PS.CURRENT;else if("number"===g)f=Math.floor(f),0>f?f=0:f>255&&(f=255);else{if(f!==PS.DEFAULT)return a._error(e+"alpha argument invalid");f=a._DEFAULTS.bead.color.a}return a._beadExec(e,a._alpha,b,c,f)},a.PSInterface.prototype.fade=function(b,c,d,e){var f,g,h,i;if(f="[PS.fade] ",PS.ERROR===a._checkNumArgs(f,arguments.length,2,4))return PS.ERROR;if(g=d,g!==PS.CURRENT&&g!==PS.DEFAULT)if(h=a._typeOf(g),"undefined"===h)g=PS.CURRENT;else{if("number"!==h)return a._error(f+"rate argument invalid");g=Math.floor(g),0>g&&(g=0)}return i=a._validFadeOptions(f,e),i===PS.ERROR?PS.ERROR:a._beadExec(f,a._fade,b,c,g,i)},a.PSInterface.prototype.scale=function(b,c,d){var e,f,g;if(e="[PS.scale] ",PS.ERROR===a._checkNumArgs(e,arguments.length,2,3))return PS.ERROR;if(f=d,f!==PS.CURRENT)if(g=a._typeOf(f),"undefined"===g)f=PS.CURRENT;else if(f===PS.DEFAULT)f=100;else{if("number"!==g)return a._error(e+"scale parameter invalid");f=Math.floor(f),50>f?f=50:f>100&&(f=100)}return a._beadExec(e,a._scale,b,c,f)},a.PSInterface.prototype.radius=function(b,c,d){var e,f,g;if(e="[PS.radius] ",PS.ERROR===a._checkNumArgs(e,arguments.length,2,3))return PS.ERROR;if(f=d,f!==PS.CURRENT)if(g=a._typeOf(f),"undefined"===g)f=PS.CURRENT;else if(f===PS.DEFAULT)f=0;else{if("number"!==g)return a._error(e+"radius parameter invalid");f=Math.floor(f),0>f?f=0:f>50&&(f=50)}return a._beadExec(e,a._radius,b,c,f)},a.PSInterface.prototype.bgColor=function(b,c,d,e,f){var g,h;return g="[PS.bgColor] ",PS.ERROR===a._checkNumArgs(g,arguments.length,2,5)?PS.ERROR:(h=a._decodeColors(g,d,e,f),h===PS.ERROR?PS.ERROR:a._beadExec(g,a._bgColor,b,c,h))},a.PSInterface.prototype.bgAlpha=function(b,c,d){var e,f,g;if(e="[PS.bgAlpha] ",PS.ERROR===a._checkNumArgs(e,arguments.length,2,3))return PS.ERROR;if(f=d,f!==PS.CURRENT)if(g=a._typeOf(f),"undefined"===g)f=PS.CURRENT;else if("number"===g)f=Math.floor(f),0>f?f=0:f>255&&(f=255);else{if(f!==PS.DEFAULT)return a._error(e+"alpha argument invalid");f=a._DEFAULTS.bead.bgColor.a}return a._beadExec(e,a._bgAlpha,b,c,f)},a.PSInterface.prototype.data=function(b,c,d){var e,f;return e="[PS.data] ",PS.ERROR===a._checkNumArgs(e,arguments.length,2,3)?PS.ERROR:(f=d,void 0===f?f=PS.CURRENT:f===PS.DEFAULT&&(f=null),a._beadExec(e,a._data,b,c,f))},a.PSInterface.prototype.exec=function(b,c,d){var e,f,g;if(e="[PS.exec] ",PS.ERROR===a._checkNumArgs(e,arguments.length,2,3))return PS.ERROR;if(f=d,f!==PS.CURRENT)if(g=a._typeOf(f),"undefined"===g)f=PS.CURRENT;else if(f===PS.DEFAULT)f=a._DEFAULTS.bead.exec;else if("function"!==g)return a._error(e+"exec argument invalid");return a._beadExec(e,a._exec,b,c,f)},a.PSInterface.prototype.visible=function(b,c,d){var e,f;return e="[PS.visible] ",PS.ERROR===a._checkNumArgs(e,arguments.length,2,3)?PS.ERROR:(f=a._isBoolean(d,PS.CURRENT,!0,PS.CURRENT),f===PS.ERROR?a._error(e+"show argument invalid"):a._beadExec(e,a._visible,b,c,f))},a.PSInterface.prototype.active=function(b,c,d){var e,f;return e="[PS.active] ",PS.ERROR===a._checkNumArgs(e,arguments.length,2,3)?PS.ERROR:(f=a._isBoolean(d,PS.CURRENT,!0,PS.CURRENT),f===PS.ERROR?a._error(e+"active argument invalid"):a._beadExec(e,a._active,b,c,f))},a.PSInterface.prototype.border=function(b,c,d){var e,f,g,h,i;if(e="[PS.border] ",PS.ERROR===a._checkNumArgs(e,arguments.length,2,3))return PS.ERROR;if(f=a._DEFAULTS.bead.border,g=d,g!==PS.CURRENT)if(h=a._typeOf(g),"undefined"===h)g=PS.CURRENT;else if(g===PS.DEFAULT)g=f.width;else if("number"===h)g=Math.floor(g),0>g&&(g=0);else{if("object"!==h)return a._error(e+"width argument invalid");if(i=g.top,i!==PS.CURRENT)if(h=a._typeOf(i),"undefined"===h)g.top=PS.CURRENT;else if("number"===h)i=Math.floor(i),0>i&&(i=0),g.top=i;else{if(i!==PS.DEFAULT)return a._error(e+".top property invalid");g.top=f.top}if(i=g.left,i!==PS.CURRENT)if(h=a._typeOf(i),"undefined"===h)g.left=PS.CURRENT;else if("number"===h)i=Math.floor(i),0>i&&(i=0),g.left=i;else{if(i!==PS.DEFAULT)return a._error(e+".left property invalid");g.left=f.left}if(i=g.bottom,i!==PS.CURRENT)if(h=a._typeOf(i),"undefined"===h)g.bottom=PS.CURRENT;else if("number"===h)i=Math.floor(i),0>i&&(i=0),g.bottom=i;else{if(i!==PS.DEFAULT)return a._error(e+".bottom property invalid");g.bottom=f.bottom}if(i=g.right,i!==PS.CURRENT)if(h=a._typeOf(i),"undefined"===h)g.right=PS.CURRENT;else if("number"===h)i=Math.floor(i),0>i&&(i=0),g.right=i;else{if(i!==PS.DEFAULT)return a._error(e+".right property invalid");g.right=f.right}}return a._beadExec(e,a._border,b,c,g)},a.PSInterface.prototype.borderColor=function(b,c,d,e,f){var g,h;return g="[PS.borderColor] ",PS.ERROR===a._checkNumArgs(g,arguments.length,2,5)?PS.ERROR:(h=a._decodeColors(g,d,e,f),h===PS.ERROR?PS.ERROR:a._beadExec(g,a._borderColor,b,c,h))},a.PSInterface.prototype.borderAlpha=function(b,c,d){var e,f,g;if(e="[PS.borderAlpha] ",PS.ERROR===a._checkNumArgs(e,arguments.length,2,3))return PS.ERROR;if(f=d,f!==PS.CURRENT)if(g=a._typeOf(f),"undefined"===g)f=PS.CURRENT;else if("number"===g)f=Math.floor(f),0>f?f=0:f>255&&(f=255);else{if(f!==PS.DEFAULT)return a._error(e+"alpha argument invalid");f=a._DEFAULTS.bead.border.color.a}return a._beadExec(e,a._borderAlpha,b,c,f)},a.PSInterface.prototype.borderFade=function(b,c,d,e){var f,g,h,i;if(f="[PS.borderFade] ",PS.ERROR===a._checkNumArgs(f,arguments.length,2,4))return PS.ERROR;if(g=d,g!==PS.CURRENT&&g!==PS.DEFAULT)if(h=a._typeOf(g),"undefined"===h)g=PS.CURRENT;else{if("number"!==h)return a._error(f+"rate argument not a number");g=Math.floor(g),0>g&&(g=0)}return i=a._validFadeOptions(f,e),i===PS.ERROR?PS.ERROR:a._beadExec(f,a._borderFade,b,c,g,i)},a.PSInterface.prototype.glyph=function(b,c,d){var e,f,g;if(e="[PS.glyph] ",PS.ERROR===a._checkNumArgs(e,arguments.length,2,3))return PS.ERROR;if(f=d,f!==PS.CURRENT)if(g=a._typeOf(f),"undefined"===g)f=PS.CURRENT;else if(f===PS.DEFAULT)f=0;else if("string"===g)f=f.length>0?f.charCodeAt(0):0;else{if("number"!==g)return a._error(e+"glyph argument invalid");f=Math.floor(f),1>f&&(f=0)}return a._beadExec(e,a._glyph,b,c,f)},a.PSInterface.prototype.glyphColor=function(b,c,d,e,f){var g,h;return g="[PS.glyphColor] ",PS.ERROR===a._checkNumArgs(g,arguments.length,2,5)?PS.ERROR:(h=a._decodeColors(g,d,e,f),h===PS.ERROR?PS.ERROR:a._beadExec(g,a._glyphColor,b,c,h))},a.PSInterface.prototype.glyphAlpha=function(b,c,d){var e,f,g;if(e="[PS.glyphAlpha] ",PS.ERROR===a._checkNumArgs(e,arguments.length,2,3))return PS.ERROR;if(f=d,f!==PS.CURRENT)if(g=a._typeOf(f),"undefined"===g)f=PS.CURRENT;else if("number"===g)f=Math.floor(f),0>f?f=0:f>255&&(f=255);else{if(f!==PS.DEFAULT)return a._error(e+"alpha argument invalid");f=a._DEFAULTS.bead.glyph.color.a}return a._beadExec(e,a._glyphAlpha,b,c,f)},a.PSInterface.prototype.glyphScale=function(b,c,d){var e,f,g;if(e="[PS.glyphScale] ",PS.ERROR===a._checkNumArgs(e,arguments.length,2,3))return PS.ERROR;if(f=d,f!==PS.CURRENT)if(g=a._typeOf(f),"undefined"===g)f=PS.CURRENT;else if("number"===g)f=Math.floor(f),50>f?f=50:f>100&&(f=100);else{if(f!==PS.DEFAULT)return a._error(e+"scale argument invalid");f=a._DEFAULTS.bead.glyph.scale}return a._beadExec(e,a._glyphScale,b,c,f)},a.PSInterface.prototype.glyphFade=function(b,c,d,e){var f,g,h,i;if(f="[PS.glyphFade] ",PS.ERROR===a._checkNumArgs(f,arguments.length,2,4))return PS.ERROR;if(g=d,g!==PS.CURRENT&&g!==PS.DEFAULT)if(h=a._typeOf(g),"undefined"===h)g=PS.CURRENT;else{if("number"!==h)return a._error(f+"rate argument not a number");g=Math.floor(g),0>g&&(g=0)}return i=a._validFadeOptions(f,e),i===PS.ERROR?PS.ERROR:a._beadExec(f,a._glyphFade,b,c,g,i)},a.PSInterface.prototype.statusText=function(b){var c,d,e;return c="[PS.statusText] ",PS.ERROR===a._checkNumArgs(c,arguments.length,0,1)?PS.ERROR:(d=b,e=a._typeOf(d),d!==PS.CURRENT&&"undefined"!==e&&(d===PS.DEFAULT?d=a._DEFAULTS.status.text:"string"!==e&&(d=d.toString()),a._statusOut(d)),a._status.text)},a.PSInterface.prototype.statusInput=function(b,c){var d,e,f,g;return d="[PS.statusInput] ",2!==arguments.length?a._error(d+"Expected 2 arguments"):"function"!=typeof c?a._error(d+"2nd argument is not a function"):(f=b,e=a._typeOf(f),"string"!==e&&(f=f.toString()),g=f.length,g>a._LABEL_MAX&&(f=f.substring(0,a._LABEL_MAX)),a._statusIn(f,c),a._status.label)},a.PSInterface.prototype.statusColor=function(b,c,d){var e,f,g,h,i,j,k;return e="[PS.statusColor] ",PS.ERROR===a._checkNumArgs(e,arguments.length,0,3)?PS.ERROR:(f=a._decodeColors(e,b,c,d),f===PS.ERROR?PS.ERROR:(g=a._status.color,h=a._status.fader,PS.CURRENT===a._checkColors(f,g,a._DEFAULTS.status.color)?g.rgb:((g.rgb!==f.rgb||h.rate>0&&null!==h.rgb&&h.rgb!==f.rgb)&&(g.rgb=f.rgb,i=f.r,j=f.g,k=f.b,g.str=f.str=a._RSTR[i]+a._GBSTR[j]+a._BASTR[k],h.rate>0?(null!==h.rgb&&a._startFader(h,h.r,h.g,h.b,255,i,j,k,255),h.active?a._recalcFader(h,i,j,k,255):a._startFader(h,g.r,g.g,g.b,255,i,j,k,255)):a._statusRGB(g),g.r=i,g.g=j,g.b=k),g.rgb)))},a.PSInterface.prototype.statusFade=function(b,c){var d,e,f,g,h,i,j,k;if(d="[PS.statusFade] ",PS.ERROR===a._checkNumArgs(d,arguments.length,0,2))return PS.ERROR;if(f=a._status.color,e=a._status.fader,g=e.rate,i=a._typeOf(b),"undefined"===i||b===PS.CURRENT)h=g;else if(b===PS.DEFAULT)h=a._DEFAULTS.fader.rate;else{if("number"!==i)return a._error(d+"rate argument invalid");h=Math.floor(b),0>h&&(h=0)}return k=a._validFadeOptions(d,c),k===PS.ERROR?PS.ERROR:(j=k.rgb,j!==PS.CURRENT&&(e.rgb=j===PS.DEFAULT?a._DEFAULTS.fader.rgb:j,e.r=k.r,e.g=k.g,e.b=k.b),j=k.onStep,j!==PS.CURRENT&&(e.onStep=j===PS.DEFAULT?a._DEFAULTS.fader.onStep:j),j=k.onEnd,j!==PS.CURRENT&&(e.onEnd=j===PS.DEFAULT?a._DEFAULTS.fader.onEnd:j),j=k.params,j!==PS.CURRENT&&(e.params=j===PS.DEFAULT?a._DEFAULTS.fader.params:j),g!==h&&(e.rate=h,1>h?(e.active=!1,e.kill=!0):e.active&&a._recalcFader(e,f.r,f.g,f.b,255)),{rate:e.rate,rgb:e.rgb,onStep:e.onStep,onEnd:e.onEnd,params:e.params})},a.PSInterface.prototype.timerStart=function(b,c){var d,e,f,g,h,i,j,k,l,m;if(d="[PS.timerStart] ",PS.ERROR===a._checkNumArgs(d,arguments.length,2,2))return PS.ERROR;if(f=b,g=c,f===PS.DEFAULT)f=60;else{if(h=a._typeOf(f),"number"!==h)return a._error(d+"ticks argument invalid");if(f=Math.floor(f),1>f)return a._error(d+"ticks argument less than one (1)")}if("function"!=typeof g)return a._error(d+"exec argument not a function");if(j=[],e>2)for(l=e-2,j.length=l,k=0;l>k;k+=1)j[k]=arguments[k+2];return m=a._TIMER_PREFIX+a._timerCnt,a._timerCnt+=1,i={id:m,delay:f,count:f,exec:g,arglist:j},a._timers.push(i),m},a.PSInterface.prototype.timerStop=function(b){var c,d,e,f;if(c="[PS.timerStop] ",PS.ERROR===a._checkNumArgs(c,arguments.length,1,1))return PS.ERROR;if("string"!=typeof b||b.length<1)return a._error(c+"id argument invalid");for(e=a._timers.length,d=0;e>d;d+=1)if(f=a._timers[d],f.id===b)return a._timers.splice(d,1),b;return a._error(c+"timer id '"+b+"' not found")},a.PSInterface.prototype.random=function(b){var c,d;return c="[PS.random] ",PS.ERROR===a._checkNumArgs(c,arguments.length,1,1)?PS.ERROR:(d=b,"number"!==a._typeOf(d)?a._error(c+"Argument not a number"):(d=Math.floor(d),2>d?1:(d=Math.random()*d,d=Math.floor(d)+1)))},a.PSInterface.prototype.makeRGB=function(b,c,d){var e,f,g,h;return e="[PS.makeRGB] ",PS.ERROR===a._checkNumArgs(e,arguments.length,3,3)?PS.ERROR:(f=b,g=c,h=d,"number"!==a._typeOf(f)?a._error(e+"r argument not a number"):(f=Math.floor(f),0>f?f=0:f>255&&(f=255),"number"!==a._typeOf(g)?a._error(e+"g argument not a number"):(g=Math.floor(g),0>g?g=0:g>255&&(g=255),"number"!==a._typeOf(h)?a._error(e+"b argument not a number"):(h=Math.floor(h),0>h?h=0:h>255&&(h=255),f*a._RSHIFT+g*a._GSHIFT+h))))},a.PSInterface.prototype.unmakeRGB=function(b,c){var d,e,f,g,h,i,j,k,l;if(d="[PS.unmakeRGB] ",PS.ERROR===a._checkNumArgs(d,arguments.length,2,2))return PS.ERROR;if(e=b,f=c,"number"!==a._typeOf(e))return a._error(d+"rgb argument not a number");if(e=Math.floor(e),1>e?(e=0,g=0,h=0,i=0):e>=16777215?(e=16777215,g=255,h=255,i=255):(g=e/a._RSHIFT,g=Math.floor(g),j=g*a._RSHIFT,h=(e-j)/a._GSHIFT,h=Math.floor(h),k=h*a._GSHIFT,i=e-j-k),l=a._typeOf(f),"object"===l)f.rgb=e,f.r=g,f.g=h,f.b=i;
else{if("array"!==l)return a._error(d+"result argument not an array or object reference");f.length<3&&(f.length=3),f[0]=g,f[1]=h,f[2]=i}return f},a.PSInterface.prototype.applyRect=function(b,c,d,e,f){var g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w;if(g="[PS.applyRect] ",PS.ERROR===a._checkNumArgs(g,arguments.length,5,5))return PS.ERROR;if(i=a._grid.x,j=a._grid.y,k=b,l=c,m=d,n=e,o=f,k===PS.DEFAULT)k=0;else{if("number"!==a._typeOf(k))return a._error(g+"left argument invalid");if(k=Math.floor(k),k>=i)return PS.DONE;0>k&&(k=0)}if(l===PS.DEFAULT)l=0;else{if("number"!==a._typeOf(l))return a._error(g+"top argument invalid");if(l=Math.floor(l),l>=j)return PS.DONE;0>l&&(l=0)}if(m===PS.DEFAULT)m=i-k;else{if("number"!==a._typeOf(m))return a._error(g+"width argument invalid");if(m=Math.floor(m),1>m)return PS.DONE;k+m>i&&(m=i-k)}if(p=k+m,n===PS.DEFAULT)n=j-l;else{if("number"!==a._typeOf(n))return a._error(g+"height argument invalid");if(n=Math.floor(n),1>n)return PS.DONE;l+n>j&&(n=j-l)}if(q=l+n,!o||"function"!=typeof o)return a._error(g+"exec argument not a function");if(u=[0,0],h>5)for(v=h-5,w=0;v>w;w+=1)u.push(arguments[w+5]);for(s=l;q>s;s+=1)for(u[1]=s,r=k;p>r;r+=1){u[0]=r;try{t=o.apply(a._EMPTY,u)}catch(x){t=a._errorCatch(g+"exec failed @"+r+", "+s+" ["+x.message+"]",x)}if(t===PS.ERROR)return PS.ERROR}return t},a.PSInterface.prototype.hex=function(b,c){var d,e,f,g,h;if(d="[PS.hex] ",e=b,f=a._typeOf(e),"number"!==f)return a._error(d+"value argument invalid");if(e=Math.floor(e),e=Math.abs(e),g=c,f=a._typeOf(g),"undefined"===f||g===PS.DEFAULT)g=2;else{if("number"!==f)return a._error(d+"padding argument invalid");g=Math.floor(g),1>g&&(g=1)}for(h=Number(e).toString(16);h.length<g;)h="0"+h;return"0x"+h},a.PSInterface.prototype.keyRepeat=function(b,c,d){var e,f,g,h,i;if(e="[PS.keyRepeat] ",g=a._isBoolean(b,a._keyRepeat,!0,!0),g===PS.ERROR)return a._error(e+"repeat argument invalid");if(i=c,f=a._typeOf(i),"undefined"===f||i===PS.DEFAULT)i=5*a._DEFAULT_KEY_DELAY;else if(i===PS.CURRENT)i=a._keyInitRate;else{if("number"!==f)return a._error(e+"init argument invalid");i=Math.floor(i),1>i&&(i=1)}if(h=d,f=a._typeOf(h),"undefined"===f||h===PS.DEFAULT)h=a._DEFAULT_KEY_DELAY;else if(h===PS.CURRENT)h=a._keyDelayRate;else{if("number"!==f)return a._error(e+"delay argument invalid");h=Math.floor(h),1>h&&(h=1)}return a._keyRepeat=g,a._keyInitRate=i,a._keyDelayRate=h,{repeat:a._keyRepeat,init:a._keyInitRate,delay:a._keyDelayRate}},a.PSInterface.prototype.imageLoad=function(b,c,d){var e,f,g,h,i,j,k,l;if(e="[PS.imageLoad] ",PS.ERROR===a._checkNumArgs(e,arguments.length,2,3))return PS.ERROR;if(f=b,g=c,h=d,"string"!=typeof f||f.length<1)return a._error(e+"filename argument invalid");if(i=f.substr(f.lastIndexOf(".")+1),i=i.toLowerCase(),"png"!==i&&"jpg"!==i&&"jpeg"!==i&&"bmp"!==i)return a._error(e+"filename extension invalid");if("function"!=typeof g)return a._error(e+"exec argument invalid");if(l=a._typeOf(h),"undefined"===l||h===PS.DEFAULT)h=4;else{if("number"!==l)return a._error(e+"format argument invalid");if(h=Math.floor(h),1>h&&h>4)return a._error(e+"format argument is not 1, 2, 3 or 4")}k=a._IMAGE_PREFIX+a._imageCnt,a._imageCnt+=1,a._imageList.push({source:f,id:k,exec:g,format:h});try{j=new Image,j.setAttribute("data-id",k),j.onload=function(){a._imageLoad(j)},j.onerror=function(){a._imageError(j)},j.src=f}catch(m){return a._errorCatch(e+"Error loading "+f+" ["+m.message+"]",m)}return k},a.PSInterface.prototype.imageBlit=function(b,c,d,e){var f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O;if(f="[PS.imageBlit] ",PS.ERROR===a._checkNumArgs(f,arguments.length,3,4))return PS.ERROR;if(g=a._grid.x,h=a._grid.y,i=b,j=c,k=d,l=e,a._validImage(f,i)===PS.ERROR)return PS.ERROR;if(m=i.width,n=i.height,o=i.pixelSize,p=i.data,q=a._typeOf(j),"undefined"===q||j===PS.DEFAULT)j=0;else{if("number"!==q)return a._error(f+"xpos argument invalid");j=Math.floor(j)}if(q=a._typeOf(k),"undefined"===q||k===PS.DEFAULT)k=0;else{if("number"!==q)return a._error(f+"ypos argument invalid");k=Math.floor(k)}if(j>=g||k>=h||1>j+m||1>k+n)return!1;if(q=a._typeOf(l),"undefined"===q||l===PS.DEFAULT)r=0,s=0,t=m,u=n;else{if("object"!==q)return a._error(f+"region argument invalid");if(s=l.left,q=a._typeOf(s),"undefined"===q||s===PS.DEFAULT)s=0;else{if("number"!==q)return a._error(f+"region.left invalid");if(s=Math.floor(s),0>s)s=0;else if(s>=m)return a._error(f+"region.left outside image")}if(r=l.top,q=a._typeOf(r),"undefined"===q||r===PS.DEFAULT)r=0;else{if("number"!==q)return a._error(f+"region.top invalid");if(r=Math.floor(r),0>r)r=0;else if(r>=n)return a._error(f+"region.top outside image")}if(t=l.width,q=a._typeOf(t),"undefined"===q||t===PS.DEFAULT)t=m-s;else{if("number"!==q)return a._error(f+"region.width invalid");if(t=Math.floor(t),1>t)return!1;s+t>m&&(t=m-s)}if(1>j+t)return!1;if(u=l.height,q=a._typeOf(u),"undefined"===q||u===PS.DEFAULT)u=n-r;else{if("number"!==q)return a._error(f+"region.height invalid");if(u=Math.floor(u),1>u)return!1;r+u>n&&(u=n-r)}if(1>k+u)return!1}if(0>j){if(t+=j,1>t)return!1;s-=j,j=0}if(w=j+t,w>g&&(t=g-j),1>t)return!1;if(0>k){if(u+=k,1>u)return!1;r-=k,k=0}if(w=k+u,w>h&&(u=h-k),1>u)return!1;for(x=m*o,O=!1,H=255,v=a._grid.plane,y=r*x+s*o,B=k,C=0;u>C;C+=1){for(z=y,A=j,D=0;t>D;D+=1)L=A+B*g,M=a._beads[L],M.active&&(O=!0,3>o?(I=p[z],E=I/a._RSHIFT,E=Math.floor(E),J=E*a._RSHIFT,F=(I-J)/a._GSHIFT,F=Math.floor(F),K=F*a._GSHIFT,G=I-J-K,2===o&&(H=p[z+1])):(E=p[z],F=p[z+1],G=p[z+2],I=E*a._RSHIFT+F*a._GSHIFT+G,4===o&&(H=p[z+3])),N=a._colorPlane(M,v),N.r=E,N.g=F,N.b=G,N.a=H,N.rgb=I,a._recolor(M)),A+=1,z+=o;B+=1,y+=x}return O&&a._gridDraw(),!0},a.PSInterface.prototype.imageCapture=function(b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y;if(d="[PS.imageCapture] ",PS.ERROR===a._checkNumArgs(d,arguments.length,0,2))return PS.ERROR;if(e=b,f=c,g=a._typeOf(e),"undefined"===g||e===PS.DEFAULT)e=3;else{if("number"!==g)return a._error(d+"format argument invalid");if(e=Math.floor(e),1>e&&e>4)return a._error(d+"format argument is not 1, 2, 3 or 4")}if(h=a._grid.x,i=a._grid.y,g=a._typeOf(f),"undefined"===g||f===PS.DEFAULT)k=0,l=0,m=h,n=i;else{if("object"!==g)return a._error(d+"region argument invalid");if(l=f.left,g=a._typeOf(l),"undefined"===g||l===PS.DEFAULT)l=0;else{if("number"!==g)return a._error(d+"region.left not a number");if(l=Math.floor(l),0>l)l=0;else if(l>=h)return a._error(d+"region.left outside grid")}if(k=f.top,g=a._typeOf(k),"undefined"===g||k===PS.DEFAULT)k=0;else{if("number"!==g)return a._error(d+"region.top not a number");if(k=Math.floor(k),0>k)k=0;else if(k>=i)return a._error(d+"region.top outside grid")}if(m=f.width,g=a._typeOf(m),"undefined"===g||m===PS.DEFAULT)m=h-l;else{if("number"!==g)return a._error(d+"region.width not a number");m=Math.floor(m),(1>m||l+m>h)&&(m=h-l)}if(n=f.height,g=a._typeOf(n),"undefined"===g||n===PS.DEFAULT)n=i-k;else{if("number"!==g)return a._error(d+"region.height not a number");n=Math.floor(n),(1>n||k+n>i)&&(n=i-k)}}if(s=a._IMAGE_PREFIX+a._imageCnt,a._imageCnt+=1,p={source:PS.GRID,id:s,width:m,height:n,pixelSize:e,valid:!0,data:[]},o=m*n,1>o)return p;for(j=p.data,j.length=o*e,q=l+m,r=k+n,t=0,v=k;r>v;v+=1)for(u=l;q>u;u+=1)w=u+v*h,x=a._beads[w],y=x.color,3>e?(j[t]=y.rgb,2===e&&(j[t+1]=y.a)):(j[t]=y.r,j[t+1]=y.g,j[t+2]=y.b,4===e&&(j[t+3]=y.a)),t+=e;return p},a.PSInterface.prototype.imageDump=function(b,c,d,e,f){var g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K;if(g="[PS.imageDump] ",PS.ERROR===a._checkNumArgs(g,arguments.length,1,5))return PS.ERROR;if(h=b,i=c,j=d,k=e,a._validImage(g,h)===PS.ERROR)return PS.ERROR;if(m=h.width,n=h.height,o=h.pixelSize,p=h.data,q=a._typeOf(i),"undefined"===q||i===PS.DEFAULT)r=0,s=0,t=m,u=n;else{if("object"!==q)return a._error(g+"region argument invalid");if(s=i.left,q=a._typeOf(s),"undefined"===q||s===PS.DEFAULT)s=0;else{if("number"!==q)return a._error(g+"region.left invalid");if(s=Math.floor(s),0>s)s=0;else if(s>=m)return a._error(g+"region.left outside grid")}if(r=i.top,q=a._typeOf(r),"undefined"===q||r===PS.DEFAULT)r=0;else{if("number"!==q)return a._error(g+"region.top invalid");if(r=Math.floor(r),0>r)r=0;else if(r>=n)return a._error(g+"region.top outside grid")}if(t=i.width,q=a._typeOf(t),"undefined"===q||t===PS.DEFAULT)t=m-s;else{if("number"!==q)return a._error(g+"region.width invalid");t=Math.floor(t),(1>t||s+t>m)&&(t=m-s)}if(u=i.height,q=a._typeOf(u),"undefined"===q||u===PS.DEFAULT)u=n-r;else{if("number"!==q)return a._error(g+"region.height invalid");u=Math.floor(u),(1>u||r+u>n)&&(u=n-r)}}if(v=t*u,q=a._typeOf(j),"undefined"===q||j===PS.DEFAULT)j=o;else{if("number"!==q)return a._error(g+"format argument invalid");if(j=Math.floor(j),1>j||j>4)return a._error(g+"format argument is not 1, 2, 3 or 4")}if(q=a._typeOf(k),"undefined"===q||k===PS.DEFAULT)k=t;else{if("number"!==q)return a._error(g+"length argument invalid");k=Math.floor(k),1>k&&(k=1),k>v&&(k=v)}if(l=a._isBoolean(f,PS.ERROR,!0,!0),l===PS.ERROR)return a._error(g+"hex argument invalid");if(w="\nvar myImage = {\n	width : "+t+", height : "+u+", pixelSize : "+j+",\n	data : [",1>v)return w+="]\n};\n",a.instance.debug(w),PS.DONE;for(w+="\n	",A=255,z=y=0,x=m*o,B=r*x+s*o,D=0;u>D;D+=1){for(C=B,E=0;t>E;E+=1)3>o?(I=p[C],1>I?F=G=H=0:I>=16777215?F=G=H=255:(F=I/a._RSHIFT,F=Math.floor(F),J=F*a._RSHIFT,G=(I-J)/a._GSHIFT,G=Math.floor(G),K=G*a._GSHIFT,H=I-J-K),2===o&&(A=p[C+1])):(F=p[C],G=p[C+1],H=p[C+2],I=F*a._RSHIFT+G*a._GSHIFT+H,4===o&&(A=p[C+3])),w+=a._outputPixel(j,l,I,F,G,H,A),z+=1,v>z&&(w+=",",y+=1,k>y?w+=" ":(y=0,w+="\n	")),C+=o;B+=x}return w+="\n	]\n};\n",a.instance.debug(w),PS.DONE},a.PSInterface.prototype.spriteSolid=function(b,c){var d,e,f,g;if(d="[PS.spriteSolid] ",PS.ERROR===a._checkNumArgs(d,arguments.length,2,2))return PS.ERROR;if(e=b,f=c,e===PS.DEFAULT)e=1;else{if("number"!==a._typeOf(e))return a._error(d+"width argument invalid");e=Math.floor(e),1>e&&(e=1)}if(f===PS.DEFAULT)f=1;else{if("number"!==a._typeOf(f))return a._error(d+"height argument invalid");f=Math.floor(f),1>f&&(f=1)}return g=a._newSprite(),g.width=e,g.height=f,g.color={rgb:0,r:0,g:0,b:0,a:255},g.id},a.PSInterface.prototype.spriteSolidColor=function(b,c,d,e){var f,g,h,i,j,k,l,m;return f="[PS.spriteSolidColor] ",PS.ERROR===a._checkNumArgs(f,arguments.length,1,4)?PS.ERROR:(g=a._getSprite(b,f),g===PS.ERROR?PS.ERROR:(i=g.color)?(h=a._decodeColors(f,c,d,e),h===PS.ERROR?PS.ERROR:(j=h.rgb,j!==PS.CURRENT&&(null===j?(k=h.r,k===PS.CURRENT?h.r=k=i.r:k===PS.DEFAULT&&(h.r=k=0),l=h.g,l===PS.CURRENT?h.g=l=i.g:l===PS.DEFAULT&&(h.g=l=0),m=h.b,m===PS.CURRENT?h.b=m=i.b:m===PS.DEFAULT&&(h.b=m=0),h.rgb=j=k*a._RSHIFT+l*a._GSHIFT+m):j===PS.DEFAULT&&(h.rgb=j=0,h.r=0,h.g=0,h.b=0),i.rgb!==j&&(i.rgb=j,i.r=h.r,i.g=h.g,i.b=h.b,g.visible&&g.placed&&(a._drawSprite(g),a._gridDraw()))),i.rgb)):a._error(f+"Cannot set color of image sprite "+g.id))},a.PSInterface.prototype.spriteSolidAlpha=function(b,c){var d,e,f,g,h,i;if(d="[PS.spriteSolidAlpha] ",PS.ERROR===a._checkNumArgs(d,arguments.length,1,2))return PS.ERROR;if(e=b,f=c,g=a._getSprite(e,d),g===PS.ERROR)return PS.ERROR;if(h=g.color,!h)return a._error(d+"Cannot set alpha of image sprite "+g.id);if(i=a._typeOf(f),"undefined"!==i&&f!==PS.CURRENT){if(f===PS.DEFAULT)f=255;else{if("number"!==i)return a._error(d+"alpha argument invalid");f=Math.floor(f),0>f?f=0:f>255&&(f=255)}h.a!==f&&(h.a=f,g.visible&&g.placed&&(a._drawSprite(g),a._gridDraw()))}return h.a},a.PSInterface.prototype.spriteImage=function(b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B;if(d="[PS.spriteImage] ",PS.ERROR===a._checkNumArgs(d,arguments.length,1,2))return PS.ERROR;if(a._validImage(d,b)===PS.ERROR)return PS.ERROR;if(k=j=0,l=e=b.width,m=f=b.height,g=b.pixelSize,h=b.data,i=a._typeOf(c),"undefined"!==i&&c!==PS.DEFAULT){if("object"!==i)return a._error(d+"region argument invalid");if(k=c.left,i=a._typeOf(k),"undefined"===i||k===PS.DEFAULT)k=0;else{if("number"!==i)return a._error(d+"region.left invalid");if(k=Math.floor(k),0>k)k=0;else if(k>=e)return a._error(d+"region.left outside image")}if(j=c.top,i=a._typeOf(j),"undefined"===i||j===PS.DEFAULT)j=0;else{if("number"!==i)return a._error(d+"region.top invalid");if(j=Math.floor(j),0>j)j=0;else if(j>=f)return a._error(d+"region.top outside image")}if(l=c.width,i=a._typeOf(l),"undefined"===i||l===PS.DEFAULT)l=e-k;else{if("number"!==i)return a._error(d+"region.width invalid");l=Math.floor(l),(1>l||k+l>e)&&(l=e-k)}if(m=c.height,i=a._typeOf(m),"undefined"===i||m===PS.DEFAULT)m=f-j;else{if("number"!==i)return a._error(d+"region.height invalid");m=Math.floor(m),(1>m||j+m>f)&&(m=f-j)}}for(n=[],n.length=l*m*4,y=255,o=e*g,p=j*o+k*g,t=0,s=0;m>s;s+=1){for(q=p,r=0;l>r;r+=1)3>g?(u=h[q],1>u?u=v=w=x=0:u>=16777215?(u=16777215,v=w=x=255):(v=u/a._RSHIFT,v=Math.floor(v),z=v*a._RSHIFT,w=(u-z)/a._GSHIFT,w=Math.floor(w),A=w*a._GSHIFT,x=u-z-A),2===g&&(y=h[q+1])):(v=h[q],w=h[q+1],x=h[q+2],4===g&&(y=h[q+3])),n[t]=v,n[t+1]=w,n[t+2]=x,n[t+3]=y,q+=g,t+=4;p+=o}return B=a._newSprite(),B.width=l,B.height=m,B.image={id:a._IMAGE_PREFIX+a._imageCnt,width:l,height:m,pixelSize:4,data:n},a._imageCnt+=1,B.id},a.PSInterface.prototype.spriteShow=function(b,c){var d,e,f,g;return d="[PS.spriteShow] ",PS.ERROR===a._checkNumArgs(d,arguments.length,1,2)?PS.ERROR:(e=b,g=a._getSprite(e,d),g===PS.ERROR?PS.ERROR:(f=a._isBoolean(c,PS.CURRENT,!0,PS.CURRENT),f===PS.ERROR?a._error(d+"show argument invalid"):(f!==PS.CURRENT&&g.visible!==f&&(g.visible=f,g.placed&&(f?(a._drawSprite(g),a._collisionCheck(g,e)):a._eraseSprite(g),a._gridDraw())),g.visible)))},a.PSInterface.prototype.spriteAxis=function(b,c,d){var e,f,g,h,i,j;if(e="[PS.spriteAxis] ",PS.ERROR===a._checkNumArgs(e,arguments.length,1,3))return PS.ERROR;if(f=b,g=c,h=d,i=a._getSprite(f,e),i===PS.ERROR)return PS.ERROR;if(j=a._typeOf(g),"undefined"===j||g===PS.CURRENT)g=i.ax;else if(g===PS.DEFAULT)g=0;else{if("number"!==j)return a._error(e+"x argument invalid");g=Math.floor(g)}if(j=a._typeOf(h),"undefined"===j||h===PS.CURRENT)h=i.ay;else if(h===PS.DEFAULT)h=0;else{if("number"!==j)return a._error(e+"y argument invalid");h=Math.floor(h)}return(g!==i.ax||h!==i.ay)&&(i.ax=g,i.ay=h,i.visible&&i.placed&&(a._drawSprite(i),a._collisionCheck(i,f),a._gridDraw())),{x:i.ax,y:i.ay}},a.PSInterface.prototype.spritePlane=function(b,c){var d,e,f,g,h;if(d="[PS.spritePlane] ",PS.ERROR===a._checkNumArgs(d,arguments.length,1,2))return PS.ERROR;if(e=b,f=c,g=a._getSprite(e,d),g===PS.ERROR)return PS.ERROR;if(h=a._typeOf(f),"undefined"!==h&&f!==PS.CURRENT){if(f===PS.DEFAULT)f=0;else{if("number"!==h)return a._error(d+"plane argument invalid");f=Math.floor(f),1>f&&(f=0)}g.plane!==f&&(g.visible&&g.placed&&a._eraseSprite(g),g.plane=f,g.visible&&g.placed&&(a._drawSprite(g),a._gridDraw()))}return g.plane<0?0:g.plane},a.PSInterface.prototype.spriteMove=function(b,c,d){var e,f,g,h,i,j,k,l,m,n,o,p,q,r,s;if(e="[PS.spriteMove] ",PS.ERROR===a._checkNumArgs(e,arguments.length,1,3))return PS.ERROR;if(f=b,g=c,h=d,i=a._getSprite(f,e),i===PS.ERROR)return PS.ERROR;if(j=a._typeOf(g),"undefined"===j||g===PS.CURRENT)g=i.x;else if(g===PS.DEFAULT)g=0;else{if("number"!==j)return a._error(e+"x argument invalid");g=Math.floor(g)}if(j=a._typeOf(h),"undefined"===j||h===PS.CURRENT)h=i.y;else if(h===PS.DEFAULT)h=0;else{if("number"!==j)return a._error(e+"y argument invalid");h=Math.floor(h)}return i.placed&&g===i.x&&h===i.y||(s=!1,i.plane<0&&(i.plane=a._grid.plane),i.visible&&i.placed&&(l=i.y,n=i.height,g>i.x?(m=g-i.x,k=i.x):i.x>g?(m=i.x-g,k=i.x+i.width-m):m=0,m>=i.width?(s=!0,a._eraseSprite(i)):(o=i.x,q=i.width,h>i.y?(r=h-i.y,p=i.y):i.y>h?(r=i.y-h,p=i.y+i.height-r):r=0,r>=i.height?(s=!0,a._eraseSprite(i)):1>r?(s=!0,a._eraseSprite(i,k,l,m,n)):1>q?(s=!0,a._eraseSprite(i,o,p,q,r)):(s=!0,q-=m,g>i.x&&(o+=m),a._eraseSprite(i,k,l,m,n),a._eraseSprite(i,o,p,q,r)))),i.x=g,i.y=h,i.placed=!0,i.visible&&(s=!0,a._drawSprite(i),a._collisionCheck(i,f)),s&&a._gridDraw()),{x:i.x,y:i.y}},a.PSInterface.prototype.spriteCollide=function(b,c){var d,e,f,g;if(d="[PS.spriteCollide] ",PS.ERROR===a._checkNumArgs(d,arguments.length,1,2))return PS.ERROR;if(e=a._getSprite(b,d),e===PS.ERROR)return PS.ERROR;if(f=c,g=a._typeOf(f),"undefined"!==g&&f!==PS.CURRENT){if(f===PS.DEFAULT)f=null;else if("function"!==g)return a._error(d+"exec argument not a function");e.collide!==f&&(e.collide=f,f&&e.visible&&e.placed&&a._collisionCheck(e,b))}return e.collide},a.PSInterface.prototype.spriteDelete=function(b){var c,d,e,f;if(c="[PS.spriteDelete] ",PS.ERROR===a._checkNumArgs(c,arguments.length,1,1))return PS.ERROR;if("string"!=typeof b||b.length<1)return a._error(c+"sprite argument invalid");for(d=a._sprites.length,e=0;d>e;e+=1)if(f=a._sprites[e],f.id===b)return a._eraseSprite(f),a._sprites.splice(e,1),a._gridDraw(),PS.DONE;return a._error(c+"sprite id '"+b+"' not found")},a.PSInterface.prototype.audioLoad=function(b,c){var d,e;return d="[PS.audioLoad] ",PS.ERROR===a._checkNumArgs(d,arguments.length,1,2)?PS.ERROR:(e=AQ.load(b,c),e===AQ.ERROR?PS.ERROR:e)},a.PSInterface.prototype.audioPlay=function(b,c){var d,e,f,g,h;if(d="[PS.audioPlay] ",PS.ERROR===a._checkNumArgs(d,arguments.length,1,2))return PS.ERROR;if(e=b,f=c,g=a._typeOf(f),"undefined"===g)f={};else if("object"!==g)return a._error(d+"params argument invalid");return f.autoplay=!0,h=AQ.load(e,f),h===AQ.ERROR?PS.ERROR:h},a.PSInterface.prototype.audioPause=function(b){var c,d;return c="[PS.audioPause] ",PS.ERROR===a._checkNumArgs(c,arguments.length,1,1)?PS.ERROR:(d=AQ.pause(b),d===AQ.ERROR?PS.ERROR:d)},a.PSInterface.prototype.audioStop=function(b){var c,d;return c="[PS.audioStop] ",PS.ERROR===a._checkNumArgs(c,arguments.length,1,1)?PS.ERROR:(d=AQ.stop(b),d===AQ.ERROR?PS.ERROR:d===AQ.DONE?PS.DONE:d)},a.PSInterface.prototype.piano=function(b,c){var d,e,f,g,h,i;if(d="[PS.piano] ",e=a._PIANO_FILES.length,g=b,f=a._typeOf(g),"number"!==f)return a._error(d+"index argument invalid");if(g=Math.floor(g),1>g?g=1:g>e&&(g=e),h=c,h!==!0&&h!==!1)if(f=a._typeOf(h),"undefined"===f)h=!1;else if("number"!==f)return a._error(d+"flag argument invalid");return i="piano_"+a._PIANO_FILES[g-1],h&&(i="l_"+i),i},a.PSInterface.prototype.harpsichord=function(b,c){var d,e,f,g,h,i;if(d="[PS.harpsichord] ",e=a._HCHORD_FILES.length,g=b,f=a._typeOf(g),"number"!==f)return a._error(d+"index argument invalid");if(g=Math.floor(g),1>g?g=1:g>e&&(g=e),h=c,h!==!0&&h!==!1)if(f=a._typeOf(h),"undefined"===f)h=!1;else if("number"!==f)return a._error(d+"flag argument invalid");return i="hchord_"+a._HCHORD_FILES[g-1],h&&(i="l_"+i),i},a.PSInterface.prototype.xylophone=function(b){var c,d,e,f,g;return c="[PS.xylophone] ",d=a._XYLO_FILES.length,f=b,e=a._typeOf(f),"number"!==e?a._error(c+"index argument invalid"):(f=Math.floor(f),1>f?f=1:f>d&&(f=d),g="xylo_"+a._XYLO_FILES[f-1])},a.PSInterface.prototype.debug=function(b){var c,d,e,f;return c="[PS.debug] ",PS.ERROR===a._checkNumArgs(c,arguments.length,0,1)?PS.ERROR:(d=b,e=a._typeOf(d),"undefined"===e?d="":"string"!==e&&(d=d.toString()),a._debugOpen(),d.length>0&&(f=document.getElementById(a._MONITOR_ID),f.value+=d,f.scrollTop=f.scrollHeight),a._scrollDown(),PS.DONE)},a.PSInterface.prototype.debugClose=function(){var b,c;return b="[PS.debugClose] ",PS.ERROR===a._checkNumArgs(b,arguments.length,0,0)?PS.ERROR:(c=document.getElementById(a._DEBUG_ID),c.style.display="none",a._debugging=!1,PS.DONE)},a.PSInterface.prototype.debugClear=function(){var b,c;return b="[PS.debugClear] ",PS.ERROR===a._checkNumArgs(b,arguments.length,0,0)?PS.ERROR:(c=document.getElementById(a._MONITOR_ID),c.value="",PS.DONE)},a.PSInterface.prototype.line=function(b,c,d,e){var f,g,h,i,j,k;return f="[PS.line] ",PS.ERROR===a._checkNumArgs(f,arguments.length,4,4)?PS.ERROR:(g=b,h=c,i=d,j=e,"number"!==a._typeOf(g)?a._error(f+"x1 argument not a number"):(g=Math.floor(g),"number"!==a._typeOf(h)?a._error(f+"y1 argument not a number"):(h=Math.floor(h),"number"!==a._typeOf(i)?a._error(f+"x2 argument not a number"):(i=Math.floor(i),"number"!==a._typeOf(j)?a._error(f+"y2 argument not a number"):(j=Math.floor(j),k=a._line(g,h,i,j))))))},a.PSInterface.prototype.pathMap=function(b){var c,d;return c="[PS.pathMap] ",PS.ERROR===a._checkNumArgs(c,arguments.length,1,1)?PS.ERROR:a._validImage(c,b)===PS.ERROR?PS.ERROR:1!==b.pixelSize?a._error(c+"image is not format 1"):(d=a._newMap(b.width,b.height,b.data),d.id)},a.PSInterface.prototype.pathFind=function(b,c,d,e,f,g){var h,i,j,k,l,m,n,o,p,q,r,s,t;if(h="[PS.pathFind] ",PS.ERROR===a._checkNumArgs(h,arguments.length,5,6))return PS.ERROR;if(i=b,j=c,k=d,l=e,m=f,n=g,"string"!=typeof i||i.length<1)return a._error(h+"pathmap argument invalid");if(o=a._getMap(i),!o)return a._error(h+i+" not found");if("number"!==a._typeOf(j))return a._error(h+"x1 argument not a number");if(j=Math.floor(j),0>j||j>=o.width)return a._error(h+"x1 argument is outside "+i);if("number"!==a._typeOf(k))return a._error(h+"y1 argument not a number");if(k=Math.floor(k),0>k||k>=o.height)return a._error(h+"y1 argument is outside "+i);if("number"!==a._typeOf(l))return a._error(h+"x2 argument not a number");if(l=Math.floor(l),0>l||l>=o.width)return a._error(h+"x2 argument is outside "+i);if("number"!==a._typeOf(m))return a._error(h+"y2 argument not a number");if(m=Math.floor(m),0>m||m>=o.height)return a._error(h+"y2 argument is outside "+i);if(s=!1,t=!1,p=a._typeOf(n),"undefined"!==p&&n!==PS.DEFAULT){if("object"!==p)return a._error(h+"options argument invalid");if(r=n.no_diagonals,r===!0||r===!1)s=r;else if(p=a._typeOf(r),"undefined"===p||r===PS.DEFAULT)s=!1;else{if("number"!==p)return a._error(h+"options.no_diagonals invalid");s=0!==r}if(r=n.cut_corners,r===!0||r===!1)t=r;else if(p=a._typeOf(r),"undefined"===p||r===PS.DEFAULT)t=!1;else{if("number"!==p)return a._error(h+"options.cut_corners invalid");t=0!==r}}return q=a._findPath(o,j,k,l,m,s,t)},a.PSInterface.prototype.pathData=function(b,c,d,e,f,g){var h,i,j,k,l,m,n,o,p,q,r;if(h="[PS.pathData] ",PS.ERROR===a._checkNumArgs(h,arguments.length,5,6))return PS.ERROR;if(i=b,j=c,k=d,l=e,m=f,n=g,"string"!=typeof i||i.length<1)return a._error(h+"pathmap argument invalid");if(o=a._getMap(i),!o)return a._error(h+i+" not found");if("number"!==a._typeOf(j))return a._error(h+"left argument not a number");if(j=Math.floor(j),0>j||j>=o.width)return a._error(h+"left argument is outside "+i);if("number"!==a._typeOf(k))return a._error(h+"top argument not a number");if(k=Math.floor(k),0>k||k>=o.height)return a._error(h+"top argument is outside "+i);if(l===PS.DEFAULT)l=1;else{if("number"!==a._typeOf(l))return a._error(h+"width argument not a number");l=Math.floor(l),1>l?l=1:(p=o.width-j,l>p&&(l=p))}if(m===PS.DEFAULT)m=1;else{if("number"!==a._typeOf(m))return a._error(h+"height argument not a number");m=Math.floor(m),1>m?m=1:(p=o.height-k,m>p&&(m=p))}if(n!==PS.DEFAULT&&n!==PS.CURRENT)if(q=a._typeOf(n),"undefined"===q)n=PS.CURRENT;else{if("number"!==q)return a._error(h+"data argument not a number");if(0>n)return a._error(h+"data argument < 0")}return r=a._pathData(o,j,k,l,m,n)},a.PSInterface.prototype.pathDelete=function(b){var c;return c="[PS.pathDelete] ",PS.ERROR===a._checkNumArgs(c,arguments.length,1,1)?PS.ERROR:"string"!=typeof b||b.length<1?a._error(c+"pathmap argument invalid"):a._deleteMap(b)?PS.DONE:a._error(c+b+" not found")},a.PSInterface.prototype.pathNear=function(b,c,d,e,f){var g,h,i;return g="[PS.pathNear] ",PS.ERROR===a._checkNumArgs(g,arguments.length,5,5)?PS.ERROR:"string"!=typeof b||b.length<1?a._error(g+"pathmap argument invalid"):(h=a._getMap(b))?i=a._pathNear(h,c,d,e,f):a._error(g+b+" not found")},a};PERLENSPIEL.RegisterModule(PerlenspielInterface);var PerlenspielInternal=function(a){"use strict";return a._system={engine:"Perlenspiel",major:3,minor:2,revision:1,audio:null,host:{app:"",version:"",os:""},inputs:{touch:!1}},a._RSTR=void 0,a._GBSTR=void 0,a._BASTR=void 0,a._ASTR=void 0,a._main=null,a._grid=void 0,a._beads=void 0,a._status=void 0,a._anyDirty=!1,a._refreshed=0,a._imageCanvas=void 0,a._imageList=void 0,a._imageCnt=void 0,a._sprites=void 0,a._spriteCnt=void 0,a._clockActive=void 0,a._timers=void 0,a._timerCnt=void 0,a._faders=void 0,a._faderTick=void 0,a._keysActive=void 0,a._transKeys=void 0,a._shiftedKeys=void 0,a._unshiftedKeys=void 0,a._pressed=void 0,a._holding=void 0,a._holdShift=void 0,a._holdCtrl=void 0,a._holdAlt,a._keyRepeat=void 0,a._keyDelay=void 0,a._keyDelayRate=void 0,a._keyInitRate=void 0,a._touchScreen=void 0,a._windowWidth=void 0,a._windowHeight=void 0,a._gridMax=void 0,a._fontMax=void 0,a._currentFinger=void 0,a._underBead=void 0,a._overGrid=void 0,a._lastBead=-1,a._debugging=void 0,a._debugFocus=void 0,a._footer=void 0,a._errorSound=void 0,a._pathmaps=void 0,a._pathmapCnt=void 0,a._footerTimer=null,a._footerDelay=50,a._footerOpacity=1,a._footerFade=function(){a._footerDelay>=0?a._footerDelay-=1:(a._footerOpacity-=.05,a._footerOpacity<=0&&(a.instance.timerStop(a._footerTimer),a._footerTimer=null,a._footerOpacity=0),a._footer.style.opacity=a._footerOpacity)},a._isMultiMode=function(){return a._options.forceMulti||a._NAMESPACE!==PS.DEFAULT_NAMESPACE},a._typeOf=function(a){var b;return b=typeof a,"number"===b?isNaN(a)&&(b="NaN"):"object"===b&&(a?a instanceof Array&&(b="array"):b="null"),b},a._isBoolean=function(b,c,d,e){var f,g;return f=b,f!==!0&&f!==!1&&(null===f?f=!1:f===PS.CURRENT?f=c:f===PS.DEFAULT?f=d:(g=a._typeOf(f),f="undefined"===g?e:"number"===g?0!==f:PS.ERROR)),f},a._copy=function(b,c){var d,e,f,g;for(d in b)b.hasOwnProperty(d)&&(e=b[d],g=a._typeOf(e),"object"===g&&(f={},a._copy(e,f),e=f),c[d]=e)},a._endEvent=function(a){return a.stopPropagation?a.stopPropagation():a.cancelBubble=!0,a.preventDefault(),!1},a._drawBead=function(b,c,d,e,f,g){var h,i,j,k,l,m,n,o,p,q;return h=a._grid.context,i=a._grid.bead_size,j=b.left,k=b.top,l=i,m=i,b.visible?(o=b.size<i,p=b.radius,(o||p>0)&&(b.bgColor.a<255&&(h.fillStyle=g,h.fillRect(j,k,l,m)),b.bgColor.a>0&&(h.fillStyle=f,h.fillRect(j,k,l,m)),o&&(j+=b.margin,k+=b.margin,l=b.size,m=b.size)),n=b.border,n.width>0&&(n.color.a<255&&(h.fillStyle=g,h.fillRect(j,k,l,m)),n.color.a>0&&(h.fillStyle=c,0===p?h.fillRect(j,k,l,m):(q=Math.floor(l*p/100),q=h.fillRoundedRect(j,k,l,m,q))),j+=n.left,k+=n.top,l-=n.left+n.right,m-=n.top+n.bottom),h.fillStyle=d,0===p?h.fillRect(j,k,l,m):(q=Math.floor(l*p/100),h.fillRoundedRect(j,k,l,m,q)),void(b.glyph.code>0&&b.glyph.color.a>0&&(a._grid.context.font=b.glyph.font,h.fillStyle=e,h.fillText(b.glyph.str,b.left+b.glyph.x,b.top+b.glyph.y)))):(h.fillStyle=g,void h.fillRect(j,k,l,m))},a._colorBlendAlpha=function(a,b){var c,d;return c=a.a*(1-b.a),d={r:Math.floor(b.r*b.a+a.r*c),g:Math.floor(b.g*b.a+a.g*c),b:Math.floor(b.b*b.a+a.b*c)}},a._calcColor=function(b,c,d){var e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t;for(e=c.r,f=c.g,g=c.b,h=b.planes,i=h.length,j=0;i>j;j+=1)l=h[j],k=l.color,m=k.r,n=k.g,o=k.b,p=k.a,p>0&&(255>p?(q=Math.max(0,Math.min(p/255,1)),r={r:e,g:f,b:g,a:1},s={r:m,g:n,b:o,a:q},t=a._colorBlendAlpha(r,s),e=t.r,f=t.g,g=t.b):(e=m,f=n,g=o));m=e,n=f,o=g,d.rgb=m*a._RSHIFT+n*a._GSHIFT+o,d.r=m,d.g=n,d.b=o,d.str=a._RSTR[m]+a._GBSTR[n]+a._BASTR[o]},a._bcolor={rgb:0,r:0,g:0,b:0,str:""},a._gridRGB=function(b){var c,d,e,f,g,h,i,j;c=b.str,d=a._grid.canvas,d.style.backgroundColor=c,a._isMultiMode()||(document.body.style.backgroundColor=c);var k=document.getElementById(a._OUTER_ID);for(k.style.backgroundColor=c,a._status.statusP.style.backgroundColor=c,a._status.inputP.style.backgroundColor=c,a._footer.style.backgroundColor=c,e=0;e<a._grid.count;e+=1)f=a._beads[e],g=f.planes[0],h=g.color,h.a<255?(a._calcColor(f,b,a._bcolor),i=a._bcolor.str):i=f.color.str,j=f.border.color,(!f.visible||f.size<a._grid.bead_size||f.radius>0||h.a<255||j.a<255)&&a._drawBead(f,j.str,i,f.glyph.color.str,f.bgColor.str,c)},a._gridRGBEnd=function(b){var c,d,e;c=b.r>127?0:255,d=b.g>127?0:255,e=b.b>127?0:255,a._footer.style.color=a._RSTR[c]+a._GBSTR[d]+a._BASTR[e]},a._gridShadowRGB=function(b){a._grid.canvas.style.boxShadow=a._grid.shadow.params+b.str},a._statusRGB=function(b){a._status.statusP.style.color=b.str,a._status.inputP.style.color=b.str},a._beadRGBA=function(b,c){var d;d=a._beads[c],a._drawBead(d,d.border.color.str,b.str,d.glyph.color.str,d.bgColor.str,a._grid.color.str)},a._borderRGBA=function(b,c){var d;d=a._beads[c],a._drawBead(d,b.str,d.color.str,d.glyph.color.str,d.bgColor.str,a._grid.color.str)},a._glyphRGBA=function(b,c){var d;d=a._beads[c],a._drawBead(d,d.border.color.str,d.color.str,b.str,d.bgColor.str,a._grid.color.str)},a._makeDirty=function(b){b.dirty=!0,a._anyDirty=!0},a._gridDraw=function(){var b,c,d;if(a._refreshed=0,a._anyDirty){for(b=a._grid.count,c=0;b>c;c+=1)d=a._beads[c],d.dirty&&(d.dirty=!1,a._drawBead(d,d.border.color.str,d.color.str,d.glyph.color.str,d.bgColor.str,a._grid.color.str),a._refreshed+=1);a._anyDirty=!1}},a._debugOpen=function(){var b;a._debugging||(b=document.getElementById(a._DEBUG_ID),b.style.display="inline",b=document.getElementById(a._MONITOR_ID),b.value="",a._debugging=!0,a._debugFocus=!1)},a._warning=function(b){("string"!=typeof b||b.length<1)&&(b="???"),a.instance.debug("WARNING: "+b+"\n")},a._checkNumArgs=function(b,c,d,e){return d>c?a._error(b+"Missing argument(s)"):c>e?a._error(b+"Too many arguments"):void 0},a._checkColors=function(b,c,d){var e,f,g,h=b.rgb;return h===PS.CURRENT?PS.CURRENT:(null===h?(e=b.r,e===PS.CURRENT?b.r=e=c.r:e===PS.DEFAULT&&(b.r=e=d.r),f=b.g,f===PS.CURRENT?b.g=f=c.g:f===PS.DEFAULT&&(b.g=f=d.g),g=b.b,g===PS.CURRENT?b.b=g=c.b:g===PS.DEFAULT&&(b.b=g=d.b),b.rgb=e*a._RSHIFT+f*a._GSHIFT+g):h===PS.DEFAULT&&a._copy(d,b),b.rgb)},a._DEBUG_STACK=!0,a._DEBUG_HTML=!1,a._decodeStackLine=function(b){var c,d,e;return c="",-1!==b.search(".js")?(d=b.lastIndexOf("/")+1,e=b.substr(d).replace(/^[\s\(\)]+|[\s\(\)]+$/g,""),3===e.split(":").length&&(e=e.substr(0,e.lastIndexOf(":"))),""!==e&&(c+="    "+e+"\n")):a._DEBUG_HTML&&-1!==b.search(".htm")&&(c+="\n"+b),c},a._decodeCallstack=function(b){var c,d,e,f;if(console&&console.log&&console.log(b),!b.split)return b;for(c=b.split("\n"),f="",d=c.length,e=0;d>e;e+=1)f+=a._decodeStackLine(c[e]);return f},a._errorCatch=function(b,c){var d;return a._clockActive=!1,a._footerTimer&&a._timers.length>0&&a.instance.timerStop(a._footerTimer),("string"!=typeof b||b.length<1)&&(b="???"),d="ERROR: "+b+"\n",a._footer.style.opacity=1,a._footer.innerHTML=d,a._DEBUG_STACK&&c&&(d+=a._decodeCallstack(c.stack)+"\n"),a.instance.debug(d),a._errorSound&&a.instance.audioPlay(a._DEFAULTS.audio.error_sound,{path:a._DEFAULTS.audio.path}),PS.ERROR},a._error=function(b){try{throw new Error("!")}catch(c){return a._errorCatch(b,c)}},a._scrollDown=function(){var b;b=document.getElementById(a._MAIN_ID),b.scrollTop=b.scrollHeight},a._initFaders=function(){a._faders=[],a._faderTick=0},a._resetFader=function(a){a.active=!1,a.kill=!1,a.r=0,a.g=0,a.b=0,a.rgb=null,a.tr=0,a.tg=0,a.tb=0,a.trgb=0,a.tstr=null,a.step=0,a.rate=0,a.onStep=null,a.onEnd=null,a.params=null,a.frames=[]},a._newFader=function(b,c,d){var e;return e={element:b,exec:c,execEnd:d,frames:[]},a._resetFader(e),e},a._calcFader=function(b,c,d,e,f,g,h,i,j){var k,l,m,n,o,p,q,r,s,t,u,v,w,x;if(b.step=0,b.frames.length=0,c!==g||d!==h||e!==i||f!==j){b.tr=g,b.tg=h,b.tb=i,b.ta=j,b.trgb=g*a._RSHIFT+h*a._GSHIFT+i,b.tstr=a._RSTR[g]+a._GBSTR[h]+a._GBSTR[i]+a._ASTR[j],k=c,l=d,m=e,n=f,s=c>g?-(c-g):g-c,t=d>h?-(d-h):h-d,u=e>i?-(e-i):i-e,v=f>j?-(f-j):j-f,o=b.rate<a._FADER_FPS?1:Math.ceil(b.rate/a._FADER_FPS),p=100/o,q=0;do if(w=!1,r={},q+=p,q>=100?(r.r=g,r.g=h,r.b=i,r.a=j):(k!==g&&(x=q*s/100,k=c+x,k=Math.round(k),w=!0),r.r=k,l!==h&&(x=q*t/100,l=d+x,l=Math.round(l),w=!0),r.g=l,m!==i&&(x=q*u/100,m=e+x,m=Math.round(m),w=!0),r.b=m,n!==j&&(x=q*v/100,n=f+x,n=Math.round(n),w=!0),r.a=n),r.rgb=r.r*a._RSHIFT+r.g*a._GSHIFT+r.b,r.str=a._RSTR[r.r]+a._GBSTR[r.g]+a._GBSTR[r.b]+a._ASTR[r.a],b.frames.push(r),!w)return;while(100>q)}},a._startFader=function(b,c,d,e,f,g,h,i,j){a._calcFader(b,c,d,e,f,g,h,i,j),b.frames.length>0&&(b.kill=!1,b.active=!0,a._faders.push(b))},a._recalcFader=function(b,c,d,e,f){var g,h,i,j;g=b.active,b.active=!1,h=b.frames.length,h>0&&(i=b.step,i>=h&&(i=h-1),j=b.frames[i],a._calcFader(b,j.r,j.g,j.b,j.a,c,d,e,f)),b.frames.length>0&&(b.active=g)},a._initTimers=function(){a._timers=[],a._timerCnt=0
},a._tick=function(){var b,c,d,e,f,g,h,i,j,k,l,m,n;if(b="[_tick] ",c=!1,a._faderTick+=1,a._faderTick>=a._FADER_FPS)for(a._faderTick=0,d=a._faders.length,e=0;d>e;)if(f=a._faders[e],h=f.frames.length,f.kill)a._faders.splice(e,1),d-=1;else if(f.active){if(g=f.frames[f.step],l=f.onStep){n=[h,f.step,g.rgb],f.params&&(n=n.concat(f.params));try{k=l.apply(a._EMPTY,n),(k===!1||null===k)&&(f.step=h-1,g=f.frames[f.step]),c=!0}catch(o){return void a._errorCatch(b+"fader .onStep failed ["+o.message+"]",o)}}if(f.exec)try{f.exec(g,f.element)}catch(p){return void a._errorCatch(b+"fader .exec failed ["+p.message+"]",p)}if(f.step+=1,f.step>=h){if(f.active=!1,f.step=0,f.frames.length=0,f.execEnd)try{f.execEnd(g,f.element)}catch(q){return void a._errorCatch(b+"fader .execEnd failed ["+q.message+"]",q)}if(l=f.onEnd){n=f.params,n||(n=[]);try{l.apply(a._EMPTY,n),c=!0}catch(r){return void a._errorCatch(b+"fader .onEnd failed ["+r.message+"]",r)}}a._faders.splice(e,1),d-=1}else e+=1}else e+=1;if(d=a._holding.length,a._keyRepeat&&d>0)if(a._keyDelay>0)a._keyDelay-=1;else for(a._keyDelay=a._keyDelayRate,e=0;d>e;e+=1)if(i=a._holding[e])try{a.instance.keyDown(i,a._holdShift,a._holdCtrl),c=!0}catch(s){return void a._errorCatch(b+"Key repeat failed ["+s.message+"]",s)}if(d=a._timers.length,d>0)for(e=0;d>e;){if(j=a._timers[e],m=j.id,j.count-=1,j.count<1){j.count=j.delay;try{k=j.exec.apply(a._EMPTY,j.arglist),c=!0}catch(t){k=a._errorCatch(b+"Timed function failed ["+t.message+"]",t)}k===PS.ERROR&&a.instance.timerStop(m),d=a._timers.length}j=a._timers[e],j&&j.id===m&&(e+=1)}c&&a._gridDraw()},a._target={rgb:0,r:0,g:0,b:0,str:""},a._recolor=function(b){var c,d,e,f,g,h,i,j,k;a._calcColor(b,a._grid.color,a._target),c=a._target.rgb,d=b.color,e=a._target.r,f=a._target.g,g=a._target.b,h=d.r,i=d.g,j=d.b,d.rgb=c,d.r=e,d.g=f,d.b=g,d.str=a._target.str,b.visible&&(k=b.fader,k.rate>0?null!==k.rgb?a._startFader(k,k.r,k.g,k.b,255,e,f,g,255):k.active?a._recalcFader(k,e,f,g,255):a._startFader(k,h,i,j,255,e,f,g,255):a._makeDirty(b))},a._validColors=function(b,c,d,e,f){var g,h,i,j;if(g=d,g!==PS.CURRENT&&g!==PS.DEFAULT)if(j=a._typeOf(g),"undefined"===j)g=PS.CURRENT;else{if("number"!==j)return a._error(b+"red value invalid");g=Math.floor(g),0>g?g=0:g>255&&(g=255)}if(h=e,h!==PS.CURRENT&&h!==PS.DEFAULT)if(j=a._typeOf(h),"undefined"===j)h=PS.CURRENT;else{if("number"!==j)return a._error(b+"green value invalid");h=Math.floor(h),0>h?h=0:h>255&&(h=255)}if(i=f,i!==PS.CURRENT&&i!==PS.DEFAULT)if(j=a._typeOf(i),"undefined"===j)i=PS.CURRENT;else{if("number"!==j)return a._error(b+"blue value invalid");i=Math.floor(i),0>i?i=0:i>255&&(i=255)}return c.rgb=null,c.r=g,c.g=h,c.b=i,PS.DONE},a._extractRGB=function(b,c){var d,e,f,g,h,i;d=Math.floor(c),1>d?d=e=g=i=0:d>=16777215?(d=16777215,e=g=i=255):(e=d/a._RSHIFT,e=Math.floor(e),f=e*a._RSHIFT,g=(d-f)/a._GSHIFT,g=Math.floor(g),h=g*a._GSHIFT,i=d-f-h),b.rgb=d,b.r=e,b.g=g,b.b=i},a._decoded={rgb:0,r:null,g:null,b:null,str:""},a._decodeColors=function(b,c,d,e){var f,g,h,i,j;if(f=a._decoded,f.rgb=0,f.r=null,f.g=null,f.b=null,f.str="",g=a._typeOf(c),void 0!==c&&void 0!==d&&void 0===e)return a._error(b+"color arguments invalid");if(void 0!==d||void 0!==e){if("number"!==g&&"undefined"!==g&&c!==PS.CURRENT&&c!==PS.DEFAULT)return a._error("array"===g?b+"Extraneous arguments after color array":"object"===g?b+"Extraneous arguments after color object":b+"red argument invalid");if(h=a._validColors(b,f,c,d,e),h===PS.ERROR)return PS.ERROR}else if("number"===g)a._extractRGB(f,c);else if("array"===g){if(j=c.length,1>j)f.rgb=PS.CURRENT;else if(h=a._validColors(b,f,c[0],c[1],c[2]),h===PS.ERROR)return PS.ERROR}else if("object"===g){if(i=c.rgb,null===i&&void 0===c.r&&void 0===c.g&&void 0===c.b)return PS.ERROR;if(g=a._typeOf(i),"undefined"===g||null===i){if(h=a._validColors(b,f,c.r,c.g,c.b),h===PS.ERROR)return PS.ERROR}else if("number"===g)a._extractRGB(f,i);else{if(i!==PS.CURRENT&&i!==PS.DEFAULT)return a._error(b+".rgb property invalid");f.rgb=i}}else if("undefined"===g||c===PS.CURRENT)f.rgb=PS.CURRENT;else{if(c!==PS.DEFAULT)return a._error(b+"color argument invalid");f.rgb=PS.DEFAULT}return f},a._rescaleGlyph=function(b){var c,d,e,f;c=a._grid.bead_size,b.glyph.x=Math.round(c/2),e=b.glyph.scale,d=100>e?Math.round(c*e/100):c,b.glyph.size=f=Math.round(d/2),b.glyph.font=f+"px sans-serif",b.glyph.y=Math.round((c-f)/2+f/2)},a._resetBead=function(b){b.dirty=!0,b.active=!0,b.visible=!0,b.planes=null,b.color={r:255,g:255,b:255,a:255,rgb:16777215,str:"rgba(255,255,255,1)"},b.bgColor={r:255,g:255,b:255,a:0,rgb:16777215,str:"rgba(255,255,255,0)"},b.radius=0,b.scale=100,b.data=0,b.exec=null,b.border={width:1,equal:!0,top:1,left:1,bottom:1,right:1,color:{r:128,g:128,b:128,a:255,rgb:8421504,str:"rgba(128,128,128,1)"}},b.glyph={str:"",code:0,scale:100,size:0,x:0,y:0,font:null,color:{r:0,g:0,b:0,a:255,rgb:0,str:"rgba(0,0,0,1)"}},b.planes=[{height:0,color:{r:255,g:255,b:255,a:255,rgb:16777215,str:"rgba(255,255,255,1)"}}],a._rescaleGlyph(b),a._resetFader(b.fader),a._resetFader(b.borderFader),a._resetFader(b.glyphFader)},a._colorPlane=function(b,c){var d,e,f,g,h,i;if(d=b.planes,1>c)return e=d[0],e.color;for(f=d.length,g=1;f>g;g+=1)if(e=d[g],e.height===c)return e.color;if(i=a._DEFAULTS.bead.color,h={rgb:i.rgb,r:i.r,g:i.g,b:i.b,a:0},b.active){for(g=0;f>g&&(e=d[g],!(e.height>c));)g+=1;d.splice(g,0,{height:c,color:h})}return h},a._borderMax=function(a){return a.glyph.code>0?a.border.gmax:a.border.max},a._equalBorder=function(a,b){a.border.equal=!0,a.border.width=b,a.border.top=b,a.border.left=b,a.border.bottom=b,a.border.right=b},a._rescale=function(b){var c,d,e,f,g,h,i;c=a._grid.bead_size,b.scale<100?(d=Math.floor(c*b.scale/100),e=c-d,e>0&&e%2&&(d+=1)):(d=c,b.margin=0,b.senseLeft=b.left,b.senseRight=b.right,b.senseTop=b.top,b.senseBottom=b.bottom),b.size=d,d!==c&&(b.margin=f=Math.floor((c-d)/2),b.senseLeft=b.left+f,b.senseRight=b.right-f,b.senseTop=b.top+f,b.senseBottom=b.bottom-f),i=b.border,i.max=Math.floor((d-8)/2),i.gmax=Math.floor((d-b.glyph.size)/2),g=a._borderMax(b),i.equal?i.width>g&&a._equalBorder(b,g):(h=i.top,h>g&&(i.top=g),h=i.left,h>g&&(i.left=g),h=i.bottom,h>g&&(i.bottom=g),h=i.right,h>g&&(i.right=g))},a._getData=function(a){var b;return b=a.data,null===b&&(b=0),b},a._touchBead=function(b){var c,d;if(a._gridFocus(),b.active){if(d=!1,c=a._getData(b),b.exec)try{b.exec(b.x,b.y,c,a._EMPTY),d=!0}catch(e){return a._errorCatch("Bead "+b.x+", "+b.y+" function failed ["+e.message+"]",e)}if(a.instance.touch)try{a.instance.touch(b.x,b.y,c,a._EMPTY),d=!0}catch(f){return a._errorCatch("PS.touch() failed ["+f.message+"]",f)}d&&a._gridDraw()}return PS.DONE},a._releaseBead=function(b){var c;if(b.active&&a.instance.release){c=a._getData(b);try{a.instance.release(b.x,b.y,c,a._EMPTY),a._gridDraw()}catch(d){return a._errorCatch("PS.release() failed ["+d.message+"]",d)}}return PS.DONE},a._enterBead=function(b){var c;if(a._overGrid=!0,b.active&&a.instance.enter){c=a._getData(b);try{a.instance.enter(b.x,b.y,c,a._EMPTY),a._gridDraw()}catch(d){return a._errorCatch("PS.enter() failed ["+d.message+"]",d)}}return PS.DONE},a._exitBead=function(b){var c;if(b.active&&a.instance.exit){c=a._getData(b);try{a.instance.exit(b.x,b.y,c,a._EMPTY),a._gridDraw()}catch(d){return a._errorCatch("PS.exit() failed ["+d.message+"]",d)}}return PS.DONE},a._exitGrid=function(){if(a._overGrid=!1,a.instance.exitGrid)try{a.instance.exitGrid(a._EMPTY),a._gridDraw()}catch(b){return a._errorCatch("PS.exitGrid() failed ["+b.message+"]",b)}return PS.DONE},a._resetCursor=function(){a._lastBead=-1},a._getBead=function(b,c){var d,e,f,g;if(d=a._grid.canvas,b+=document.body.scrollLeft+document.documentElement.scrollLeft-d.offsetLeft-a._grid.padLeft,c+=document.body.scrollTop+document.documentElement.scrollTop-d.offsetTop-a._grid.padRight,b>=a._grid.left&&b<a._grid.right&&c>=a._grid.top&&c<a._grid.bottom)for(f=0;f<a._grid.count;){if(e=a._beads[f],c>=e.top&&c<e.bottom){for(g=0;g<a._grid.x;g+=1){if(b>=e.senseLeft&&b<e.senseRight&&c>=e.senseTop&&c<e.senseBottom)return e;f+=1,e=a._beads[f]}return null}f+=a._grid.x}return null},a._mouseDown=function(b){var c,d,e;return b.x&&b.y?(c=b.x,d=b.y):(c=b.clientX,d=b.clientY),e=a._getBead(c,d),e?a._touchBead(e):a._gridUnfocus(b),a._isMultiMode()?a._endEvent(b):void b.preventDefault()},a._mouseUp=function(b){var c,d,e;return b.x&&b.y?(c=b.x,d=b.y):(c=b.clientX,d=b.clientY),e=a._getBead(c,d),e&&a._releaseBead(e),a._endEvent(b)},a._mouseMove=function(b){var c,d,e,f;return b.x&&b.y?(c=b.x,d=b.y):(c=b.clientX,d=b.clientY),e=a._getBead(c,d),e?e.index!==a._lastBead&&(a._lastBead>=0&&(f=a._beads[a._lastBead],a._exitBead(f)),a._enterBead(e),a._lastBead=e.index):a._lastBead>=0&&(f=a._beads[a._lastBead],a._exitBead(f),a._lastBead=-1),a._endEvent(b)},a._gridOut=function(b){var c,d;return a._lastBead>=0&&(c=a._beads[a._lastBead],a._exitBead(c),a._lastBead=-1),d=b.relatedTarget,d&&(d=d.id,d&&(d===a._OUTER_ID||d===a._MAIN_ID||d.length<1)&&a._exitGrid()),a._endEvent(b)},a._touchStart=function(b){var c,d,e,f;return a._currentFinger!==a._CLEAR?a._endEvent(b):(e=b.changedTouches[0],a._currentFinger=e.identifier,c=e.pageX,d=e.pageY,f=a._getBead(c,d),f?(a._overGrid=!0,a._underBead=f.index,a._touchBead(f)):(a._underBead=a._CLEAR,a._overGrid=!1),a._endEvent(b))},a._touchEnd=function(b){var c,d,e,f,g,h,i;for(c=b.changedTouches.length,d=0;c>d;d+=1)if(e=b.changedTouches[d],f=e.identifier,f===a._currentFinger){a._currentFinger=a._CLEAR,a._underBead=a._CLEAR,a._overGrid=!1,g=e.pageX,h=e.pageY,i=a._getBead(g,h),i&&a._releaseBead(i);break}return a._endEvent(b)},a._touchMove=function(b){var c,d,e,f,g,h,i,j;for(c=b.changedTouches.length,d=0;c>d;d+=1)if(e=b.changedTouches[d],f=e.identifier,f===a._currentFinger){g=e.pageX,h=e.pageY,i=a._getBead(g,h),i?(a._overGrid=!0,a._underBead!==i.index&&(a._underBead!==a._CLEAR&&(j=a._beads[a._underBead],a._exitBead(j)),a._underBead=i.index,a._enterBead(i))):(a._underBead!==a._CLEAR&&(j=a._beads[a._underBead],a._exitBead(j)),a._underBead=a._CLEAR,a._overGrid&&a._exitGrid());break}return a._endEvent(b)},a._keyReset=function(){var b;for(a._holding.length=0,a._holdShift=!1,a._holdCtrl=!1,a._holdAlt=!1,b=0;256>b;b+=1)a._pressed[b]=0},a._keyFilter=function(b,c){var d;return d=b,d>=65&&90>=d?c||(d+=32):(d=a._transKeys[d],c&&256>d&&(d=a._shiftedKeys[d])),d},a._legalKey=function(a){return a>=32||13===a||8===a||9===a||27===a},a._keyDown=function(b){if(a._grid.focused){var c,d,e,f,g,h;if(c="[_keyDown] ",d=!1,a._debugFocus)return!0;if(a.instance.keyDown){if(a._holdShift=b.shiftKey,a._holdCtrl=b.ctrlKey,a._holdAlt=b.altKey,e=b.which?b.which:b.keyCode,f=a._keyFilter(e,a._holdShift),a._legalKey(f)){if(!a._pressed[f]){a._pressed[f]=1,f!==e&&a._pressed[e]&&(a._pressed[e]=0,h=a._holding.indexOf(e),h>=0&&a._holding.splice(h,1)),a._holding.length<1&&(a._keyDelay=a._keyInitRate),a._holding.indexOf(f)<0&&a._holding.push(f);try{a.instance.keyDown(f,a._holdShift,a._holdCtrl,a._EMPTY),d=!0}catch(i){a._errorCatch(c+"PS.keyDown failed ["+i.message+"]",i)}}}else if(f===a._KEY_SHIFT)for(g=a._holding.length,h=0;g>h;h+=1)if(f=e=a._holding[h],e>=97&&122>=e?f-=32:256>e&&(f=a._shiftedKeys[e]),f!==e){a._pressed[e]=0,a._pressed[f]=1,a._holding[h]=f;try{a.instance.keyDown(f,!0,a._holdCtrl,a._EMPTY),d=!0}catch(j){a._errorCatch(c+"PS.keyDown failed ["+j.message+"]",j)}}d&&a._gridDraw()}return a._endEvent(b)}},a._keyUp=function(b){if(a._grid.focused){var c,d,e,f,g,h,i,j;if(c="[_keyUp] ",d=!1,a._debugFocus)return!0;if(a.instance.keyUp){if(e=a._holdShift=b.shiftKey,f=a._holdCtrl=b.ctrlKey,g=b.which?b.which:b.keyCode,h=a._keyFilter(g,a._holdShift),a._legalKey(h)){a._pressed[h]=0,i=a._holding.indexOf(h),i>=0&&a._holding.splice(i,1),a._holding.length<1&&(a._keyDelay=0,a._holdShift=!1,a._holdCtrl=!1,a._holdAlt=!1);try{a.instance.keyUp(h,e,f,a._EMPTY),d=!0}catch(k){a._errorCatch(c+"PS.keyUp failed ["+k.message+"]",k)}}else if(h===a._KEY_SHIFT)for(j=a._holding.length,i=0;j>i;i+=1)if(h=g=a._holding[i],256>g&&(h=a._unshiftedKeys[g]),h!==g){a._pressed[g]=0,a._pressed[h]=1,a._holding[i]=h;try{a.instance.keyDown(h,!1,f,a._EMPTY),d=!0}catch(l){a._errorCatch(c+"PS.keyDown failed ["+l.message+"]",l)}}d&&a._gridDraw()}return a._endEvent(b)}},a._wheel=function(b){if(a._grid.focused){var c;if(!a._overGrid)return!0;if(a.instance.input){b||(b=window.event),c=Math.max(-1,Math.min(1,b.wheelDelta||-b.detail)),c=c>=1?PS.WHEEL_FORWARD:PS.WHEEL_BACKWARD;try{a.instance.input({wheel:c},a._EMPTY),a._gridDraw()}catch(d){a._errorCatch("PS.input() failed ["+d.message+"]",d)}}return a._endEvent(b)}},a._keysActivate=function(){a._keysActive||(document.addEventListener("keydown",a._keyDown,!1),document.addEventListener("keyup",a._keyUp,!1),a._keysActive=!0,a._isMultiMode()||a._gridFocus())},a._keysDeactivate=function(){a._keyReset(),a._keysActive&&(document.removeEventListener("keydown",a._keyDown,!1),document.removeEventListener("keyup",a._keyUp,!1),a._keysActive=!1,a._gridBlur())},a._gridFocus=function(b){a._grid.focused||(a._grid.canvas.focus&&a._grid.canvas.focus(),a._grid.focused=!0,PERLENSPIEL.Broadcast("Focused",{namespace:a._NAMESPACE})),b&&b.preventDefault()},a._gridBlur=function(){a._grid.canvas.blur&&a._grid.canvas.blur(),a._grid.focused=!1},a._onBroadcast=function(b,c){"Focused"===b&&c.namespace!==a._NAMESPACE&&a._gridBlur()},a._gridUnfocus=function(b){if(a._grid.focused){var c=b.target,d=a._grid.canvas,e=document.getElementById(a._MAIN_ID),f=document.getElementById(a._OUTER_ID),g=document.getElementById(a._FOOTER_ID);if(c===d||c===a._status.div||c===g||c===e||c===f)return;a._grid.canvas.blur&&a._grid.canvas.blur(),a._grid.focused=!1,b&&b.preventDefault()}},a._gridActivate=function(){var b;if(b=a._grid.canvas,b.style.display="block",b.focused=!a._isMultiMode(),b.addEventListener("mousedown",a._mouseDown,!1),b.addEventListener("mouseup",a._mouseUp,!1),b.addEventListener("mousemove",a._mouseMove,!1),b.addEventListener("mouseout",a._gridOut,!1),a._keysActivate(),a._isMultiMode()){var c=document.getElementById(a._OUTER_ID);c.addEventListener("mousedown",a._gridFocus,!0),document.addEventListener("mousedown",a._gridUnfocus,!1)}document.addEventListener("keydown",a._keyDown,!1),document.addEventListener("keyup",a._keyUp,!1),window.addEventListener("DOMMouseScroll",a._wheel,!1),window.addEventListener("mousewheel",a._wheel,!1),a._touchScreen&&(a._currentFinger=a._CLEAR,a._underBead=a._CLEAR,document.addEventListener("touchmove",a._touchMove,!1),document.addEventListener("touchstart",a._touchStart,!1),document.addEventListener("touchend",a._touchEnd,!1),document.addEventListener("touchcancel",a._touchEnd,!1))},a._gridDeactivate=function(){var b;if(b=a._grid.canvas,b.style.display="none",b.removeEventListener("mousedown",a._mouseDown,!1),b.removeEventListener("mouseup",a._mouseUp,!1),b.removeEventListener("mousemove",a._mouseMove,!1),b.removeEventListener("mouseout",a._gridOut,!1),a._keysDeactivate(),a._isMultiMode()){var c=document.getElementById(a._OUTER_ID);c&&c.removeEventListener("mousedown",a._gridFocus,!0),document.removeEventListener("mousedown",a._gridUnfocus,!1)}document.removeEventListener("keydown",a._keyDown,!1),document.removeEventListener("keyup",a._keyUp,!1),window.removeEventListener("DOMMouseScroll",a._wheel,!1),window.removeEventListener("mousewheel",a._wheel,!1),a._touchScreen&&(document.removeEventListener("touchmove",a._touchMove,!1),document.removeEventListener("touchstart",a._touchStart,!1),document.removeEventListener("touchend",a._touchEnd,!1),document.removeEventListener("touchcancel",a._touchEnd,!1))},a._gridColor=function(b){var c,d,e,f,g;return c=a._grid.color,d=a._grid.fader,PS.CURRENT===a._checkColors(b,c,a._DEFAULTS.grid.color)?c.rgb:((c.rgb!==b.rgb||d.rate>0&&null!==d.rgb&&d.rgb!==b.rgb)&&(c.rgb=b.rgb,e=b.r,f=b.g,g=b.b,c.str=b.str=a._RSTR[e]+a._GBSTR[f]+a._BASTR[g],d.rate>0?null!==d.rgb?a._startFader(d,d.r,d.g,d.b,255,e,f,g,255):d.active?a._recalcFader(d,e,f,g,255):a._startFader(d,c.r,c.g,c.b,255,e,f,g,255):(a._gridRGB(b),a._gridRGBEnd(b)),c.r=e,c.g=f,c.b=g),c.rgb)},a._gridShadow=function(b,c){var d,e,f,g,h;return d=a._grid.shadow,PS.CURRENT===a._checkColors(c,d,a._DEFAULTS.grid.shadow)?d.rgb:(e=c.rgb,d.rgb!==c.rgb&&(d.rgb=c.rgb,f=c.r,g=c.g,h=c.b,d.str=c.str=a._RSTR[f]+a._GBSTR[g]+a._BASTR[h],d.r=f,d.g=g,d.b=h),b!==PS.CURRENT&&(a._grid.shadow.show=b),a._grid.shadow.show?a._gridShadowRGB(d):a._grid.canvas.style.boxShadow="none",{show:a._grid.shadow.show,rgb:d.rgb})},a._gridSize=function(b,c){var d,e,f,g,h,i,j;if(a._initFaders(),a._resetFader(a._grid.fader),a._resetFader(a._status.fader),a._grid.plane=0,a._grid.ready&&b===a._grid.x&&c===a._grid.y)for(e=0;e<a._grid.count;e+=1)j=a._beads[e],a._resetBead(j),a._rescale(j);else{for(a._grid.x=b,a._grid.y=c,a._grid.count=b*c,a._grid.left=0,a._grid.top=0,d=Math.floor(b>=c?a._gridMax/b:a._gridMax/c),a._grid.bead_size=d,a._grid.width=d*b,a._grid.height=d*c,a._grid.right=a._grid.width,a._grid.bottom=a._grid.height,a._grid.canvas.width=a._grid.width,a._grid.canvas.height=a._grid.height,a._grid.context.textAlign="center",a._grid.context.textBaseline="middle",g=0,i=a._grid.top,f=0;c>f;f+=1){for(h=a._grid.left,e=0;b>e;e+=1)j=a._beads[g],j.x=e,j.y=f,j.left=h,j.right=h+d,j.top=i,j.bottom=i+d,a._resetBead(j),a._rescale(j),h+=d,g+=1;i+=d}for(;g<a._MAX_BEADS;)j=a._beads[g],j.visible=!1,j.active=!1,g+=1}a._anyDirty=!0,a._gridColor({rgb:PS.DEFAULT}),a.instance.statusColor(PS.DEFAULT),a._gridDraw(),a._resetCursor(),a._grid.ready=!0},a._checkX=function(b,c){return"number"!==a._typeOf(b)?a._error(c+"x argument not a number"):(b=Math.floor(b),0>b?a._error(c+"x argument negative"):b>=a._grid.x?a._error(c+"x argument exceeds grid width"):b)},a._checkY=function(b,c){return"number"!==a._typeOf(b)?a._error(c+"y argument not a number"):(b=Math.floor(b),0>b?a._error(c+"y argument negative"):b>=a._grid.y?a._error(c+"y argument exceeds grid height"):b)},a._beadExec=function(b,c,d,e,f,g,h,i){var j,k,l;if(d===PS.ALL){if(e===PS.ALL){for(k=0;k<a._grid.y;k+=1)for(j=0;j<a._grid.x&&(l=c(j,k,f,g,h,i),l!==PS.ERROR);j+=1);return l}if(e=a._checkY(e,b),e===PS.ERROR)return PS.ERROR;for(j=0;j<a._grid.x&&(l=c(j,e,f,g,h,i),l!==PS.ERROR);j+=1);return l}if(e===PS.ALL){if(d=a._checkX(d,b),d===PS.ERROR)return PS.ERROR;for(k=0;k<a._grid.y&&(l=c(d,k,f,g,h,i),l!==PS.ERROR);k+=1);return l}return d=a._checkX(d,b),d===PS.ERROR?PS.ERROR:(e=a._checkY(e,b),e===PS.ERROR?PS.ERROR:l=c(d,e,f,g,h,i))},a._color=function(b,c,d){var e,f,g,h;return e=c*a._grid.x+b,f=a._beads[e],g=a._colorPlane(f,a._grid.plane),h=f.fader,f.active?PS.CURRENT===a._checkColors(d,g,a._DEFAULTS.bead.color)?g.rgb:((g.rgb!==d.rgb||h.rate>0&&null!==h.rgb&&h.rgb!==d.rgb)&&(g.rgb=d.rgb,g.r=d.r,g.g=d.g,g.b=d.b,a._recolor(f)),g.rgb):g.rgb},a._alpha=function(b,c,d){var e,f,g;return e=c*a._grid.x+b,f=a._beads[e],g=a._colorPlane(f,a._grid.plane),f.active&&d!==PS.CURRENT&&d!==g.a&&(g.a=d,a._recolor(f)),g.a},a._validFadeOptions=function(b,c){var d,e,f,g,h,i,j;if(d=a._typeOf(c),"undefined"===d||c===PS.CURRENT)return{rgb:PS.CURRENT,r:0,g:0,b:0,onStep:PS.CURRENT,onEnd:PS.CURRENT,params:PS.CURRENT};if(c===PS.DEFAULT)return{rgb:PS.DEFAULT,r:0,g:0,b:0,onStep:PS.CURRENT,onEnd:PS.DEFAULT,params:PS.DEFAULT};if("object"!==d)return a._error(b+"options argument invalid");if(e=c.rgb,e!==PS.CURRENT&&e!==PS.DEFAULT)if(d=a._typeOf(e),"undefined"===d||null===e)c.rgb=PS.CURRENT;else{if("number"!==d)return a._error(b+"options.rgb property invalid");e=Math.floor(e),e<=PS.COLOR_BLACK?(e=PS.COLOR_BLACK,f=0,h=0,g=0):e>=PS.COLOR_WHITE?(e=PS.COLOR_WHITE,f=255,h=255,g=255):(f=e/a._RSHIFT,f=Math.floor(f),i=f*a._RSHIFT,h=(e-i)/a._GSHIFT,h=Math.floor(h),j=h*a._GSHIFT,g=e-i-j),c.rgb=e,c.r=f,c.g=h,c.b=g}else c.r=0,c.g=0,c.b=0;if(e=c.onStep,e!==PS.CURRENT&&e!==PS.DEFAULT)if(d=a._typeOf(e),"undefined"===d||null===e)c.onStep=PS.CURRENT;else if("function"!==d)return a._error(b+"options.onStep property invalid");if(e=c.onEnd,e!==PS.CURRENT&&e!==PS.DEFAULT)if(d=a._typeOf(e),"undefined"===d||null===e)c.onEnd=PS.CURRENT;else if("function"!==d)return a._error(b+"options.onEnd property invalid");if(e=c.params,e!==PS.CURRENT&&e!==PS.DEFAULT)if(d=a._typeOf(e),"undefined"===d||null===e)c.params=PS.CURRENT;else if("array"!==d)return a._error(b+"options.params property invalid");return c},a._fade=function(b,c,d,e){var f,g,h,i,j,k,l;return f=c*a._grid.x+b,g=a._beads[f],h=g.color,i=g.fader,j=i.rate,g.active&&(k=d===PS.CURRENT?j:d===PS.DEFAULT?a._DEFAULTS.fader.rate:d,l=e.rgb,l!==PS.CURRENT&&(i.rgb=l===PS.DEFAULT?a._DEFAULTS.fader.rgb:l,i.r=e.r,i.g=e.g,i.b=e.b),l=e.onStep,l!==PS.CURRENT&&(i.onStep=l===PS.DEFAULT?a._DEFAULTS.fader.onStep:l),l=e.onEnd,l!==PS.CURRENT&&(i.onEnd=l===PS.DEFAULT?a._DEFAULTS.fader.onEnd:l),l=e.params,l!==PS.CURRENT&&(i.params=l===PS.DEFAULT?a._DEFAULTS.fader.params:l),j!==k&&(i.rate=k,1>k?(i.active=!1,i.kill=!0):i.active&&a._recalcFader(i,h.r,h.g,h.b,255))),{rate:i.rate,rgb:i.rgb,onStep:i.onStep,onEnd:i.onEnd,params:i.params}},a._scale=function(b,c,d){var e,f;return e=c*a._grid.x+b,f=a._beads[e],f.active&&d!==PS.CURRENT&&f.scale!==d&&(f.scale=d,a._rescale(f),a._makeDirty(f)),f.scale},a._radius=function(b,c,d){var e,f,g;return e=c*a._grid.x+b,f=a._beads[e],f.active&&d!==PS.CURRENT&&f.radius!==d&&(f.radius=d,!f.border.equal&&d>0&&(g=Math.max(f.border.top,f.border.left,f.border.bottom,f.border.right),a._equalBorder(f,g)),a._makeDirty(f)),f.radius},a._bgColor=function(b,c,d){var e,f,g,h,i,j;return e=c*a._grid.x+b,f=a._beads[e],g=f.bgColor,f.active?PS.CURRENT===a._checkColors(d,g,a._DEFAULTS.bead.bgColor)?g.rgb:(g.rgb!==d.rgb&&(g.rgb=d.rgb,g.r=h=d.r,g.g=i=d.g,g.b=j=d.b,g.str=a._RSTR[h]+a._GBSTR[i]+a._GBSTR[j]+a._ASTR[g.a],f.active&&(f.scale<100||f.radius>0)&&a._makeDirty(f)),g.rgb):g.rgb},a._bgAlpha=function(b,c,d){var e,f,g;return e=c*a._grid.x+b,f=a._beads[e],g=f.bgColor,d!==PS.CURRENT&&d!==g.a&&(g.a=d,g.str=a._RSTR[g.r]+a._GBSTR[g.g]+a._GBSTR[g.b]+a._ASTR[d],f.active&&(f.scale<100||f.radius>0)&&a._makeDirty(f)),g.a},a._data=function(b,c,d){var e,f;return e=c*a._grid.x+b,f=a._beads[e],f.active&&d!==PS.CURRENT&&(null===d?(f.data=a._DEFAULTS.bead.data,f.fader.data=f.data,f.borderFader.data=f.data,f.glyphFader.data=f.data):(f.data=d,f.fader.data=d,f.borderFader.data=d,f.glyphFader.data=d)),f.data},a._exec=function(b,c,d){var e,f;return e=c*a._grid.x+b,f=a._beads[e],f.active&&d!==PS.CURRENT&&(f.exec=d),f.exec},a._visible=function(b,c,d){var e,f;return e=c*a._grid.x+b,f=a._beads[e],f.active&&d!==PS.CURRENT&&f.visible!==d&&(f.visible=d,d||(f.fader.kill=!0,f.borderFader.kill=!0,f.glyphFader.kill=!0),a._makeDirty(f)),f.visible},a._active=function(b,c,d){var e,f;return e=c*a._grid.x+b,f=a._beads[e],d!==PS.CURRENT&&(f.active=d),f.active},a._border=function(b,c,d){var e,f,g,h,i,j,k,l,m;return e=c*a._grid.x+b,f=a._beads[e],f.active&&d!==PS.CURRENT&&(g=a._borderMax(f),"number"===a._typeOf(d)?(d>g&&(d=g),d!==f.border.width&&(a._equalBorder(f,d),a._makeDirty(f))):(i=!1,j=d.top,j===PS.CURRENT?j=f.border.top:(j>g&&(j=g),j!==f.border.top&&(f.border.top=j,i=!0)),k=d.left,k===PS.CURRENT?k=f.border.left:(k>g&&(k=g),k!==f.border.left&&(f.border.left=k,i=!0)),l=d.bottom,l===PS.CURRENT?l=f.border.bottom:(l>g&&(l=g),l!==f.border.bottom&&(f.border.bottom=l,i=!0)),m=d.right,m===PS.CURRENT?m=f.border.right:(m>g&&(m=g),m!==f.border.right&&(f.border.right=m,i=!0)),j===k&&j===m&&j===l?(a._equalBorder(f,j),i&&a._makeDirty(f)):f.radius>0?(g=Math.max(j,k,l,m),a._equalBorder(f,g),a._makeDirty(f)):(f.border.equal=!1,i&&a._makeDirty(f)))),h={top:f.border.top,left:f.border.left,bottom:f.border.bottom,right:f.border.right,equal:f.border.equal},f.border.equal||(f.border.width=Math.max(h.top,h.left,h.bottom,h.right)),h.width=f.border.width,h},a._borderColor=function(b,c,d){var e,f,g,h,i,j,k,l;return e=c*a._grid.x+b,f=a._beads[e],g=f.border.color,h=f.borderFader,f.active?PS.CURRENT===a._checkColors(d,g,a._DEFAULTS.bead.border.color)?g.rgb:((g.rgb!==d.rgb||h.rate>0&&null!==h.rgb&&h.rgb!==d.rgb)&&(g.rgb=d.rgb,i=d.r,j=d.g,k=d.b,d.a=l=g.a,g.str=d.str=a._RSTR[i]+a._GBSTR[j]+a._GBSTR[k]+a._ASTR[l],f.visible&&(h.rate>0?null!==h.rgb?a._startFader(h,h.r,h.g,h.b,l,i,j,k,l):h.active?a._recalcFader(h,i,j,k,l):a._startFader(h,g.r,g.g,g.b,l,i,j,k,l):a._makeDirty(f)),g.r=i,g.g=j,g.b=k),g.rgb):g.rgb},a._borderAlpha=function(b,c,d){var e,f,g,h,i,j,k;return e=c*a._grid.x+b,f=a._beads[e],g=f.border.color,f.active&&d!==PS.CURRENT&&d!==g.a&&(h=g.r,i=g.g,j=g.b,g.str=a._RSTR[h]+a._GBSTR[i]+a._GBSTR[j]+a._ASTR[d],f.visible&&(k=f.borderFader,k.rate>0?k.active?a._recalcFader(k,h,i,j,d):null!==k.rgb?a._startFader(k,k.r,k.g,k.b,g.a,h,i,j,d):a._startFader(k,h,i,j,g.a,h,i,j,d):a._makeDirty(f)),g.a=d),g.a},a._borderFade=function(b,c,d,e){var f,g,h,i,j,k,l;return f=c*a._grid.x+b,g=a._beads[f],i=g.border.color,h=g.borderFader,j=h.rate,g.active&&(k=d===PS.CURRENT?j:d===PS.DEFAULT?a._DEFAULTS.fader.rate:d,l=e.rgb,l!==PS.CURRENT&&(h.rgb=l===PS.DEFAULT?a._DEFAULTS.fader.rgb:l,h.r=e.r,h.g=e.g,h.b=e.b),l=e.onStep,l!==PS.CURRENT&&(h.onStep=l===PS.DEFAULT?a._DEFAULTS.fader.onStep:l),l=e.onEnd,l!==PS.CURRENT&&(h.onEnd=l===PS.DEFAULT?a._DEFAULTS.fader.onEnd:l),l=e.params,l!==PS.CURRENT&&(h.params=l===PS.DEFAULT?a._DEFAULTS.fader.params:l),j!==k&&(h.rate=k,1>k?(h.active=!1,h.kill=!0):h.active&&a._recalcFader(h,i.r,i.g,i.b,255))),{rate:h.rate,rgb:h.rgb,onStep:h.onStep,onEnd:h.onEnd,params:h.params}},a._glyph=function(b,c,d){var e,f,g;return e=c*a._grid.x+b,f=a._beads[e],f.active&&d!==PS.CURRENT&&f.glyph.code!==d&&(f.glyph.code=d,g=1>d?"":String.fromCodePoint(d),f.glyph.str=g,a._makeDirty(f)),f.glyph.code},a._glyphColor=function(b,c,d){var e,f,g,h,i,j,k,l;return e=c*a._grid.x+b,f=a._beads[e],g=f.glyph.color,h=f.glyphFader,f.active?PS.CURRENT===a._checkColors(d,g,a._DEFAULTS.bead.glyph.color)?g.rgb:((g.rgb!==d.rgb||h.rate>0&&null!==h.rgb&&h.rgb!==d.rgb)&&(g.rgb=d.rgb,i=d.r,j=d.g,k=d.b,d.a=l=g.a,g.str=d.str=a._RSTR[i]+a._GBSTR[j]+a._GBSTR[k]+a._ASTR[l],f.visible&&(h.rate>0?(null!==h.rgb&&a._startFader(h,h.r,h.g,h.b,l,i,j,k,l),h.active?a._recalcFader(h,i,j,k,l):a._startFader(h,g.r,g.g,g.b,l,i,j,k,l)):a._makeDirty(f)),g.r=i,g.g=j,g.b=k),g.rgb):g.rgb},a._glyphAlpha=function(b,c,d){var e,f,g,h,i,j,k;return e=c*a._grid.x+b,f=a._beads[e],g=f.glyph.color,f.active&&d!==PS.CURRENT&&d!==g.a&&(h=g.r,i=g.g,j=g.b,g.str=a._RSTR[h]+a._GBSTR[i]+a._GBSTR[j]+a._ASTR[d],f.visible&&(k=f.glyphFader,k.rate>0?k.active?a._recalcFader(k,h,i,j,d):a._startFader(k,h,i,j,g.a,h,i,j,d):a._makeDirty(f)),g.a=d),g.a},a._glyphScale=function(b,c,d){var e,f,g;return e=c*a._grid.x+b,f=a._beads[e],g=f.glyph.scale,f.active&&d!==PS.CURRENT&&d!==g&&(f.glyph.scale=d,f.visible&&(a._rescaleGlyph(f),a._makeDirty(f))),f.glyph.scale},a._glyphFade=function(b,c,d,e){var f,g,h,i,j,k,l;return f=c*a._grid.x+b,g=a._beads[f],h=g.glyph.color,i=g.glyphFader,j=i.rate,g.active&&(k=d===PS.CURRENT?j:d===PS.DEFAULT?a._DEFAULTS.fader.rate:d,l=e.rgb,l!==PS.CURRENT&&(i.rgb=l===PS.DEFAULT?a._DEFAULTS.fader.rgb:l,i.r=e.r,i.g=e.g,i.b=e.b),l=e.onStep,l!==PS.CURRENT&&(i.onStep=l===PS.DEFAULT?a._DEFAULTS.fader.onStep:l),l=e.onEnd,l!==PS.CURRENT&&(i.onEnd=l===PS.DEFAULT?a._DEFAULTS.fader.onEnd:l),l=e.params,l!==PS.CURRENT&&(i.params=l===PS.DEFAULT?a._DEFAULTS.fader.params:l),j!==k&&(i.rate=k,1>k?(i.active=!1,i.kill=!0):i.active&&a._recalcFader(i,h.r,h.g,h.b,255))),{rate:i.rate,rgb:i.rgb,onStep:i.onStep,onEnd:i.onEnd,params:i.params}},a._imageError=function(b){var c,d,e,f,g;for(c=b.getAttribute("data-id"),d=a._imageList.length,e=0;d>e;e+=1)if(f=a._imageList[e],f.id===c){g=f.exec,a._imageList.splice(e,1);break}try{g(PS.ERROR)}catch(h){a._errorCatch("[PS.imageLoad] .exec function failed ["+h.message+"]",h)}a._error("[PS.imageLoad] Error loading "+b.src)},a._imageExtract=function(b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r;if(d="[_imageExtract] ",e=b.width,"number"!==a._typeOf(e)||1>e)return a._error(d+"image width invalid");if(e=Math.floor(e),f=b.height,"number"!==a._typeOf(f)||1>f)return a._error(d+"image height invalid");f=Math.floor(f);try{a._imageCanvas.width=e,a._imageCanvas.height=f,g=a._imageCanvas.getContext("2d"),g.drawImage(b,0,0,e,f,0,0,e,f)}catch(s){return a._errorCatch(d+"image extraction failed @ 1 ["+s.message+"]",s)}try{h=g.getImageData(0,0,e,f)}catch(t){return a._errorCatch(d+"image extraction failed @ 2 ["+t.message+"]",t)}if(i={width:h.width,height:h.height},j=h.data,k=j.length,l=[],n=m=0,1===c)for(l.length=k/4;k>m;)o=j[m],p=j[m+1],q=j[m+2],l[n]=o*a._RSHIFT+p*a._GSHIFT+q,m+=4,n+=1;else if(2===c)for(l.length=k/2;k>m;)o=j[m],p=j[m+1],q=j[m+2],r=j[m+3],l[n]=o*a._RSHIFT+p*a._GSHIFT+q,l[n+1]=r,m+=4,n+=2;else if(3===c)for(l.length=k/4*3;k>m;)o=j[m],p=j[m+1],q=j[m+2],l[n]=o,l[n+1]=p,l[n+2]=q,m+=4,n+=3;else for(l.length=k;k>m;)l[m]=j[m],m+=1,l[m]=j[m],m+=1,l[m]=j[m],m+=1,l[m]=j[m],m+=1;return i.pixelSize=c,i.data=l,i},a._imageLoad=function(b){var c,d,e,f,g,h,i,j;for(c=b.getAttribute("data-id"),d=a._imageList.length,e=0;d>e;e+=1)if(f=a._imageList[e],f.id===c){g=f.exec,h=f.format,i=f.source,a._imageList.splice(e,1);break}if(j=a._imageExtract(b,h),j!==PS.ERROR)try{j.source=i,j.id=c,g(j)}catch(k){a._errorCatch("[PS.imageLoad] .exec function failed ["+k.message+"]",k)}},a._validImage=function(b,c){var d,e,f,g,h,i,j,k;if("object"!==a._typeOf(c))return a._error(b+"image argument not an object");if(d=c.width,"number"!==a._typeOf(d))return a._error(b+"image.width not a number");if(d=Math.floor(d),1>d)return a._error(b+"image.width < 1");if(c.width=d,e=c.height,"number"!==a._typeOf(e))return a._error(b+"image.height not a number");if(e=Math.floor(e),1>e)return a._error(b+"image.height < 1");if(c.height=e,f=c.pixelSize,"number"!==a._typeOf(f))return a._error(b+"image.pixelSize not a number");if(f=Math.floor(f),1>f&&f>4)return a._error(b+"image.pixelSize is not 1, 2, 3 or 4");if(c.pixelSize=f,h=c.data,"array"!==a._typeOf(h))return a._error(b+"image.data is not an array");if(i=h.length,g=d*e*f,i!==g)return a._error(b+"image.data length invalid");for(j=0;i>j;j+=1){if(k=h[j],"number"!==a._typeOf(k))return a._error(b+"image.data["+j+"] not a number");if(0>k)return a._error(b+"image.data["+j+"] negative");if(3>f){if(k>16777215)return a._error(b+"image.data["+j+"] > 0xFFFFFF")}else if(k>255)return a._error(b+"image.data["+j+"] > 255")}return!0},a._hex=function(a,b){var c,d;if(c=a.toString(16).toUpperCase(),b)for(d=c.length;b>d;)c="0"+c,d+=1;return"0x"+c.toUpperCase()},a._outputPixel=function(b,c,d,e,f,g,h){var i;return 3>b?(i="",i+=c?a._hex(d,6):d,2===b&&(i+=c?", "+a._hex(h,2):", "+h)):(i=c?a._hex(e,2)+", "+a._hex(f,2)+", "+a._hex(g,2):e+", "+f+", "+g,4===b&&(i+=c?", "+a._hex(h,2):", "+h)),i},a._newSprite=function(){var b;return b={id:a._SPRITE_PREFIX+a._spriteCnt,placed:!1,visible:!0,x:0,y:0,ax:0,ay:0,image:null,color:null,collide:null,width:0,height:0,plane:-1},a._spriteCnt+=1,a._sprites.push(b),b},a._getSprite=function(b,c){var d,e,f;if("string"!=typeof b||b.length<1)return a._error(c+"sprite argument invalid");for(d=a._sprites.length,e=0;d>e;e+=1)if(f=a._sprites[e],f.id===b)return f;return a._error(c+"sprite id '"+b+"' does not exist")},a._eraseSprite=function(b,c,d,e,f){var g,h,i,j,k,l,m,n,o;if(void 0===c&&(c=b.x,d=b.y,e=b.width,f=b.height),g=a._grid.x,c-=b.ax,!(c>=g)){if(0>c){if(e+=c,1>e)return;c=0}if(c+e>g&&(e=g-c),i=c+e,h=a._grid.y,d-=b.ay,!(d>=h)){if(0>d){if(f+=d,1>f)return;d=0}for(d+f>h&&(f=h-d),j=d+f,l=d;j>l;l+=1)for(k=c;i>k;k+=1)n=k+l*g,m=a._beads[n],m.active&&(o=a._colorPlane(m,b.plane),o.r=255,o.g=255,o.b=255,o.a=0,o.rgb=16777215,a._recolor(m))}}},a._drawSprite=function(b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x;if(c=b.width,d=b.height,!(1>c||1>d||(e=a._grid.x,k=0,g=b.x-b.ax,g>=e))){if(0>g){if(c+=g,1>c)return;g=0,k=b.width-c}if(g+c>e&&(c=e-g),i=g+c,f=a._grid.y,l=0,h=b.y-b.ay,!(h>=f)){if(0>h){if(d+=h,1>d)return;h=0,l=b.height-d}if(h+d>f&&(d=f-h),j=h+d,m=b.color)for(o=h;j>o;o+=1)for(n=g;i>n;n+=1)q=n+o*e,p=a._beads[q],p.active&&(r=a._colorPlane(p,b.plane),r.rgb=m.rgb,r.r=m.r,r.g=m.g,r.b=m.b,r.a=m.a,a._recolor(p));else for(s=b.image.data,o=h;j>o;o+=1){for(t=4*(l*b.width+k),n=g;i>n;n+=1)q=n+o*e,p=a._beads[q],p.active&&(u=s[t],v=s[t+1],w=s[t+2],x=s[t+3],r=a._colorPlane(p,b.plane),r.rgb=u*a._RSHIFT+v*a._GSHIFT+w,r.r=u,r.g=v,r.b=w,r.a=x,a._recolor(p)),t+=4;
l+=1}}}},a._collisionCheck=function(b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u;for(d="[_collisionCheck] ",g=b.x-b.ax,h=b.y-b.ay,i=b.width,j=b.height,k=b.collide,e=a._sprites.length,f=0;e>f;f+=1)if(l=a._sprites[f],m=l.id,m!==c&&l.visible&&l.placed&&(n=l.x-l.ax,o=l.y-l.ay,p=l.width,q=l.height,r=l.collide,s=n>g?n-g:g-n,t=o>h?o-h:h-o,u=null,g===n-i||g===n+p?(o>=h&&j>=t||h>=o&&q>=t)&&(u=PS.SPRITE_TOUCH):h===o-j||h===o+q?(n>=g&&i>=s||g>=n&&p>=s)&&(u=PS.SPRITE_TOUCH):g>=n&&n+p>g?(o>=h&&j>t||h>=o&&q>t)&&(u=PS.SPRITE_OVERLAP):n>=g&&g+i>n&&(h>=o&&q>t||o>=h&&j>t)&&(u=PS.SPRITE_OVERLAP),u)){if(k)try{k(c,b.plane,m,l.plane,u)}catch(v){return void a._errorCatch(d+c+" collide function failed ["+v.message+"]",v)}if(r)try{r(m,l.plane,c,b.plane,u)}catch(w){return void a._errorCatch(d+m+" collide function failed ["+w.message+"]",w)}}},a.BinaryHeap=function(a){this.content=[],this.scoreFunction=a},a.BinaryHeap.prototype={push:function(a){this.content.push(a),this.bubbleUp(this.content.length-1)},pop:function(){var a,b;return a=this.content[0],b=this.content.pop(),this.content.length>0&&(this.content[0]=b,this.sinkDown(0)),a},remove:function(a){var b,c,d;for(b=this.content.length,c=0;b>c;c+=1)if(this.content[c]===a){d=this.content.pop(),c!==b-1&&(this.content[c]=d,this.bubbleUp(c),this.sinkDown(c));break}},size:function(){var a;return a=this.content.length},bubbleUp:function(a){var b,c,d,e;for(b=this.content[a],c=this.scoreFunction(b);a>0&&(d=Math.floor((a+1)/2)-1,e=this.content[d],!(c>=this.scoreFunction(e)));)this.content[d]=b,this.content[a]=e,a=d},sinkDown:function(a){var b,c,d,e,f,g,h,i,j,k;for(b=this.content.length,c=this.content[a],d=this.scoreFunction(c);;){if(f=2*(a+1),e=f-1,g=null,b>e&&(h=this.content[e],i=this.scoreFunction(h),d>i&&(g=e)),b>f&&(j=this.content[f],k=this.scoreFunction(j),(null===g?d:i)>k&&(g=f)),null===g)break;this.content[a]=this.content[g],this.content[g]=c,a=g}},rescore:function(a){this.sinkDown(this.content.indexOf(a))}},a._line=function(a,b,c,d){var e,f,g,h,i,j,k;for(e=c>a?c-a:a-c,f=d>b?d-b:b-d,g=c>a?1:-1,h=d>b?1:-1,i=e-f,k=[];a!==c||b!==d;){if(j=2*i,j>-f&&(i-=f,a+=g),a===c&&b===d){k.push([a,b]);break}e>j&&(i+=e,b+=h),k.push([a,b])}return k},a._lineWall=function(a,b,c,d,e,f){var g,h,i,j,k,l,m,n,o;for(g=e>c?e-c:c-e,h=f>d?f-d:d-f,i=e>c?1:-1,j=f>d?1:-1,k=g-h,m=[];c!==e||d!==f;){if(l=2*k,l>-h&&(k-=h,c+=i),c===e&&d===f)return m.push([c,d]),m;if(g>l&&(k+=g,d+=j),o=d*b+c,n=a[o],!n.value)return null;m.push([c,d])}return m},a._heuristic=function(b,c,d,e){var f,g,h;return f=d>b?d-b:b-d,g=e>c?e-c:c-e,h=f>g?g*a._DIAGONAL_COST+(f-g):f*a._DIAGONAL_COST+(g-f)},a._neighbors=function(b,c,d,e,f,g){var h,i,j,k,l,m,n,o,p,q,r,s,t,u,v;return h=[],i=e.x,j=e.y,k=c-1,l=d-1,o=j*c,m=(j-1)*c,n=(j+1)*c,s=!1,t=!1,u=!1,v=!1,i>0&&(p=i-1,q=o+p,r=b[q],r.value?r.closed||(r.cost=r.value,h.push(r)):v=!0),k>i&&(p=i+1,q=o+p,r=b[q],r.value?r.closed||(r.cost=r.value,h.push(r)):u=!0),j>0&&(q=m+i,r=b[q],r.value?r.closed||(r.cost=r.value,h.push(r)):s=!0),l>j&&(q=n+i,r=b[q],r.value?r.closed||(r.cost=r.value,h.push(r)):t=!0),f||(i>0&&(p=i-1,j>0&&(g||!v&&!s)&&(q=m+p,r=b[q],r.value&&!r.closed&&(r.cost=r.value*a._DIAGONAL_COST,h.push(r))),l>j&&(g||!v&&!t)&&(q=n+p,r=b[q],r.value&&!r.closed&&(r.cost=r.value*a._DIAGONAL_COST,h.push(r)))),k>i&&(p=i+1,j>0&&(g||!s&&!u)&&(q=m+p,r=b[q],r.value&&!r.closed&&(r.cost=r.value*a._DIAGONAL_COST,h.push(r))),l>j&&(g||!t&&!u)&&(q=n+p,r=b[q],r.value&&!r.closed&&(r.cost=r.value*a._DIAGONAL_COST,h.push(r))))),h},a._score=function(a){return a.f},a._findPath=function(b,c,d,e,f,g,h){var i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x;if(c===e&&d===f)return[];if(i=b.width,j=b.height,k=b.nodes,l=d*i+c,m=k[l],!m.value)return[];if(l=f*i+e,m=k[l],!m.value)return[];if(!g&&(n=a._lineWall(k,i,c,d,e,f)))return n;for(o=k.length,t=0;o>t;t+=1)m=k[t],m.f=0,m.g=0,m.h=0,m.cost=0,m.closed=!1,m.visited=!1,m.parent=null;for(n=[],p=new a.BinaryHeap(a._score),l=d*i+c,m=k[l],p.push(m);p.size()>0;){if(q=p.pop(),q.x===e&&q.y===f){for(x=q;x.parent;)n.push([x.x,x.y]),x=x.parent;n.reverse();break}for(q.closed=!0,r=a._neighbors(k,i,j,q,g,h),s=r.length,t=0;s>t;t+=1)u=r[t],v=q.g+u.cost,w=u.visited,(!w||v<u.g)&&(u.visited=!0,u.parent=q,u.h=u.h||a._heuristic(u.x,u.y,e,f),u.g=v,u.f=u.g+u.h,w?p.rescore(u):p.push(u))}return n},a._pathData=function(a,b,c,d,e,f){var g,h,i,j,k,l,m,n;for(g=[],g.length=d*e,h=a.nodes,i=c+e,m=0,l=c;i>l;l+=1)for(j=l*a.width+b,k=0;d>k;k+=1)n=h[j],f!==PS.CURRENT&&(n.value=f===PS.DEFAULT?n.ovalue:f),g[m]=n.value,m+=1,j+=1;return g},a._newMap=function(b,c,d){var e,f,g,h,i,j,k,l;for(f=d.length,e=[],e.length=f,g=0,i=0;c>i;i+=1)for(h=0;b>h;h+=1)k=d[g],j={x:h,y:i,value:k,ovalue:k,f:0,g:0,h:0,cost:0,parent:null,closed:!1,visited:!1},e[g]=j,g+=1;return l={id:a._PATHMAP_PREFIX+a._pathmapCnt,width:b,height:c,nodes:e},a._pathmapCnt+=1,a._pathmaps.push(l),l},a._getMap=function(b){var c,d,e;for(c=a._pathmaps.length,d=0;c>d;d+=1)if(e=a._pathmaps[d],e.id===b)return e;return null},a._deleteMap=function(b){var c,d,e,f,g;for(c=a._pathmaps.length,d=0;c>d;d+=1)if(e=a._pathmaps[d],e.id===b){for(f=e.nodes,c=f.length,g=0;c>g;g+=1)f[g]=null;return e.nodes=null,a._pathmaps.splice(d,1),!0}return!1},a._pathNear=function(b,c,d,e,f){var g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y;for(g=b.nodes,h=b.width,i=b.height,j=1;h>j;){if(k=[],l=e-j,n=e+j,m=f-j,o=f+j,p=l,0>p&&(p=0),q=n+1,q>=h&&(q=h),m>=0)for(r=m*h+p,s=p;q>s;s+=1)t=g[r],t.value&&k.push([t.x,t.y]),r+=1;if(i>o)for(r=o*h+p,s=p;q>s;s+=1)t=g[r],t.value&&k.push([t.x,t.y]),r+=1;if(p=m+1,0>p&&(p=0),q=o,q>=i&&(q=i),l>=0)for(r=p*h+l,s=p;q>s;s+=1)t=g[r],t.value&&k.push([t.x,t.y]),r+=h;if(h>n)for(r=p*h+n,s=p;q>s;s+=1)t=g[r],t.value&&k.push([t.x,t.y]),r+=h;if(u=k.length){if(1===u)return k[0];for(v=h+i,s=0;u>s;s+=1)y=k[s],x=a._heuristic(c,d,y[0],y[1]),v>x&&(v=x,w=s);return k[w]}j+=1}return[c,d]},a._statusOut=function(b){a._status.inputP.style.display="none",a._status.statusNode.nodeValue=a._status.text=b,a._status.statusP.style.display="block"},a._inputKeyDown=function(b){var c,d,e;if(c=b.which,c||(c=b.keyCode),c===PS.KEY_ENTER){if(d=a._status.input.value,e=a._status.exec,"function"==typeof e)try{e(d)}catch(f){a._errorCatch("PS.statusInput() function failed ["+f.message+"]",f)}return a._status.input.removeEventListener("keydown",a._inputKeyDown,!1),a._statusOut(a._status.text),a._endEvent(b)}return!0},a._statusIn=function(b,c){var d;a._status.statusP.style.display="none",a._status.label=d=b,d.length<1&&(d=">"),a._status.inputNode.nodeValue=d,a._status.exec=c,a._status.input.value="",a._keysDeactivate(),a._status.input.addEventListener("keydown",a._inputKeyDown,!1),a._status.inputP.style.display="block",a._status.input.focus()},a._hasTouch=function(){try{return document.createEvent("TouchEvent"),!0}catch(a){return!1}},a._systemDetect=function(){var b,c,d,e,f;if(b=window.navigator.userAgent.toLowerCase(),c=window.navigator.platform.toLowerCase(),/firefox/.test(b)?(d="Firefox",/fennec/.test(b)&&(d+=" Mobile"),f=/firefox\/[\.\d]+/.exec(b)[0].split("/")[1]):/chrome/.test(b)?(d="Chrome",f=/chrome\/[\d\.]+/.exec(b)[0].split("/")[1]):/safari/.test(b)?(d="Safari",(/iphone/.test(b)||/ipad/.test(b)||/ipod/.test(b))&&(e="iOS")):/msie/.test(b)?(d="Internet Explorer",/iemobile/.test(b)&&(d+=" Mobile"),f=/msie \d+[.]\d+/.exec(b)[0].split(" ")[1]):/trident/.test(b)?(d="Internet Explorer",f=/rv\:\d+[.]\d+/.exec(b)[0].split(":")[1]):/opera/.test(b)?(d="Opera",/mini/.test(b)?d+=" Mini":/mobile/.test(b)&&(d+=" Mobile")):/android/.test(b)&&(d="Android",e=/android\s[\.\d]+/.exec(b)),!f)try{f=/version\/[\.\d]+/.exec(b),f=f?f[0].split("/")[1]:/opera\/[\.\d]+/.exec(b)[0].split("/")[1]}catch(g){console.error("Problem detecting browser: "+g.message),f=""}"win32"===c||"win64"===c?e="Windows":("macintel"===c||"macppc"===c)&&(e="Mac OS X ",e+=/10[\.\_\d]+/.exec(b)[0],/[\_]/.test(e)&&(e=e.split("_").join("."))),e||(/linux/.test(c)?e="Linux":/windows/.test(b)&&(e="Windows")),a._system.host.app=d,f&&(a._system.host.version=f),a._system.host.os=e},a._sizeDetect=function(){var b,c,d,e,f,g,h;a._windowWidth=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,a._windowHeight=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight,b=a._MAX_GRID_SIZE/4*5,a._windowWidth>=b&&a._windowHeight>=b?(e=a._MAX_GRID_SIZE,f=a._MAX_FONT_SIZE,g=a._MAX_SHADOW_SIZE,h=a._MAX_BLUR_SIZE):(c=a._windowWidth/5*4,d=a._windowHeight/5*4,e=Math.min(c,d),e=8*Math.floor(e/8),f=a._MAX_FONT_SIZE*(e/a._MAX_GRID_SIZE),f=Math.floor(100*f)/100,h=a._MAX_BLUR_SIZE*(e/a._MAX_GRID_SIZE),h=Math.floor(h),g=Math.floor(h/8)),a._gridMax=e,a._fontMax=f+"em",a._DEFAULTS.grid.shadow.params="0px 0px "+h+"px "+g+"px "},a};PERLENSPIEL.RegisterModule(PerlenspielInternal);var PS;!function(){PS=PERLENSPIEL.Create({namespace:"game"}),window.addEventListener("load",function(){1===PERLENSPIEL.NumInstances()&&PERLENSPIEL.AutoStartEnabled()&&PS.start()},!1)}();